<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis | 跳跳猪</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.jpg">
    <meta name="description" content="吃得好，睡得好">
    
    <link rel="preload" href="/assets/css/0.styles.542f065b.css" as="style"><link rel="preload" href="/assets/js/app.9ac200f5.js" as="script"><link rel="preload" href="/assets/js/2.f08c2e94.js" as="script"><link rel="preload" href="/assets/js/16.7aa17999.js" as="script"><link rel="prefetch" href="/assets/js/10.104e03e5.js"><link rel="prefetch" href="/assets/js/11.18d17b89.js"><link rel="prefetch" href="/assets/js/12.31c398a8.js"><link rel="prefetch" href="/assets/js/13.b5ee2d7d.js"><link rel="prefetch" href="/assets/js/14.a60f524e.js"><link rel="prefetch" href="/assets/js/15.55fd61b8.js"><link rel="prefetch" href="/assets/js/17.24758699.js"><link rel="prefetch" href="/assets/js/18.0b71a4f7.js"><link rel="prefetch" href="/assets/js/19.4770b075.js"><link rel="prefetch" href="/assets/js/20.fe4d448c.js"><link rel="prefetch" href="/assets/js/21.6ef119a3.js"><link rel="prefetch" href="/assets/js/22.68798857.js"><link rel="prefetch" href="/assets/js/23.a8a337ba.js"><link rel="prefetch" href="/assets/js/24.c156d0fe.js"><link rel="prefetch" href="/assets/js/25.b840f4b8.js"><link rel="prefetch" href="/assets/js/26.37c5f756.js"><link rel="prefetch" href="/assets/js/27.5b776d07.js"><link rel="prefetch" href="/assets/js/28.4d89a988.js"><link rel="prefetch" href="/assets/js/29.d8405b8b.js"><link rel="prefetch" href="/assets/js/3.98efb80c.js"><link rel="prefetch" href="/assets/js/30.67c25a87.js"><link rel="prefetch" href="/assets/js/31.cd45304b.js"><link rel="prefetch" href="/assets/js/32.b0bff8a4.js"><link rel="prefetch" href="/assets/js/33.b8e0beb7.js"><link rel="prefetch" href="/assets/js/34.eedead55.js"><link rel="prefetch" href="/assets/js/35.44fef23e.js"><link rel="prefetch" href="/assets/js/36.3e7830e5.js"><link rel="prefetch" href="/assets/js/37.8f711bb3.js"><link rel="prefetch" href="/assets/js/38.3b7df8b6.js"><link rel="prefetch" href="/assets/js/39.a7dfb50c.js"><link rel="prefetch" href="/assets/js/4.2e894fd2.js"><link rel="prefetch" href="/assets/js/40.ba597a3a.js"><link rel="prefetch" href="/assets/js/41.0955ce39.js"><link rel="prefetch" href="/assets/js/42.b1629e72.js"><link rel="prefetch" href="/assets/js/43.606f57ec.js"><link rel="prefetch" href="/assets/js/44.5e8f4801.js"><link rel="prefetch" href="/assets/js/45.fc255c2f.js"><link rel="prefetch" href="/assets/js/46.9222248d.js"><link rel="prefetch" href="/assets/js/47.d6bf833e.js"><link rel="prefetch" href="/assets/js/48.40e23b48.js"><link rel="prefetch" href="/assets/js/49.ba7c2b8d.js"><link rel="prefetch" href="/assets/js/5.d2ef2a1a.js"><link rel="prefetch" href="/assets/js/50.487406c6.js"><link rel="prefetch" href="/assets/js/51.3f8ea397.js"><link rel="prefetch" href="/assets/js/52.acd66974.js"><link rel="prefetch" href="/assets/js/53.58c7fc05.js"><link rel="prefetch" href="/assets/js/54.0f8282f4.js"><link rel="prefetch" href="/assets/js/55.ad7bb205.js"><link rel="prefetch" href="/assets/js/56.590655d9.js"><link rel="prefetch" href="/assets/js/57.9a85aa7a.js"><link rel="prefetch" href="/assets/js/58.1b4ef9fd.js"><link rel="prefetch" href="/assets/js/59.9420c0ba.js"><link rel="prefetch" href="/assets/js/6.65a955fd.js"><link rel="prefetch" href="/assets/js/60.30009201.js"><link rel="prefetch" href="/assets/js/61.0047220f.js"><link rel="prefetch" href="/assets/js/62.a368a893.js"><link rel="prefetch" href="/assets/js/63.3315d70a.js"><link rel="prefetch" href="/assets/js/64.3e3c478f.js"><link rel="prefetch" href="/assets/js/65.80a47305.js"><link rel="prefetch" href="/assets/js/66.ae967862.js"><link rel="prefetch" href="/assets/js/67.606a99c5.js"><link rel="prefetch" href="/assets/js/68.46eb6539.js"><link rel="prefetch" href="/assets/js/69.c6067a0e.js"><link rel="prefetch" href="/assets/js/7.ed4f4e88.js"><link rel="prefetch" href="/assets/js/8.517c5e6e.js"><link rel="prefetch" href="/assets/js/9.bef30b40.js">
    <link rel="stylesheet" href="/assets/css/0.styles.542f065b.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://excalidraw.com/apple-touch-icon.png" alt="跳跳猪" class="logo"> <span class="site-name can-hide">跳跳猪</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/md/java/JAVA基础.html" class="nav-link">JAVA</a></div><div class="nav-item"><a href="/md/database/mysql/MySql操作.html" class="nav-link">数据库</a></div><div class="nav-item"><a href="/md/opSystem/linux/linux操作笔记.html" class="nav-link">操作系统</a></div><div class="nav-item"><a href="/md/middleware/mq/消息队列.html" class="nav-link">中间件</a></div><div class="nav-item"><a href="/md/tool/docker/docker.html" class="nav-link">开发工具</a></div><div class="nav-item"><a href="/md/designPattern/" class="nav-link">设计模式</a></div><div class="nav-item"><a href="/md/netty/BIO、NIO、AIO.html" class="nav-link">netty</a></div><div class="nav-item"><a href="/md/DDD/小傅哥案例学习打卡/DDD抽奖系统学习打卡🚀 day 1.html" class="nav-link">DDD</a></div><div class="nav-item"><a href="/md/other/面试题.html" class="nav-link">other</a></div><div class="nav-item"><a href="/md/notes/" class="nav-link">测试</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="提示语" class="dropdown-title"><!----> <span class="title" style="display:;">测试下拉菜单</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/notes/" class="nav-link">菜单1</a></li><li class="dropdown-item"><!----> <a href="/md/notes/" class="nav-link">菜单2</a></li><li class="dropdown-item"><h4>多次菜单</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/notes/" class="nav-link">多级菜单1</a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/md/java/JAVA基础.html" class="nav-link">JAVA</a></div><div class="nav-item"><a href="/md/database/mysql/MySql操作.html" class="nav-link">数据库</a></div><div class="nav-item"><a href="/md/opSystem/linux/linux操作笔记.html" class="nav-link">操作系统</a></div><div class="nav-item"><a href="/md/middleware/mq/消息队列.html" class="nav-link">中间件</a></div><div class="nav-item"><a href="/md/tool/docker/docker.html" class="nav-link">开发工具</a></div><div class="nav-item"><a href="/md/designPattern/" class="nav-link">设计模式</a></div><div class="nav-item"><a href="/md/netty/BIO、NIO、AIO.html" class="nav-link">netty</a></div><div class="nav-item"><a href="/md/DDD/小傅哥案例学习打卡/DDD抽奖系统学习打卡🚀 day 1.html" class="nav-link">DDD</a></div><div class="nav-item"><a href="/md/other/面试题.html" class="nav-link">other</a></div><div class="nav-item"><a href="/md/notes/" class="nav-link">测试</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="提示语" class="dropdown-title"><!----> <span class="title" style="display:;">测试下拉菜单</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/notes/" class="nav-link">菜单1</a></li><li class="dropdown-item"><!----> <a href="/md/notes/" class="nav-link">菜单2</a></li><li class="dropdown-item"><h4>多次菜单</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/notes/" class="nav-link">多级菜单1</a></li></ul></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>mysql</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/e391b2/" class="sidebar-link">MySql操作</a></li><li><a href="/pages/44cc10/" class="sidebar-link">mysql事务锁查询并处理</a></li><li><a href="/pages/eea5d0/" class="sidebar-link">sql优化</a></li><li><a href="/pages/0e9f6d/" class="sidebar-link">索引</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/6b1641/" aria-current="page" class="active sidebar-link">Redis</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/6b1641/#使用redisson实现分布式锁" class="sidebar-link">使用redisson实现分布式锁</a></li></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>md</span></li><li data-v-06225672><span data-v-06225672>database</span></li><li data-v-06225672><span data-v-06225672>redis</span></li></ul> <div class="info" data-v-06225672><!----> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-10-28</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">Redis<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="redis"><a href="#redis" class="header-anchor">#</a> Redis</h1> <p>redis和memoryCache的对比: redis支持持久化, 当内存中数据丢失时可通过持久化方式恢复</p> <h1 id="五种数据类型"><a href="#五种数据类型" class="header-anchor">#</a> 五种数据类型</h1> <p>String 字符串</p> <p>Hash 面向对象的结构</p> <p>List 双向链表</p> <p>Set 集合</p> <p>ZSet 有序集合</p> <p>bitmap  位图</p> <p>HyperLogLog  统计</p> <p>GEO  地理位置</p> <p>Stream</p> <h1 id="常用场景"><a href="#常用场景" class="header-anchor">#</a> 常用场景</h1> <ul><li><p>string：
简单地 get / set 缓存。</p> <p>做计数, 点赞数等等</p></li> <li><p>hash：</p> <p>可以缓存用户资料。比如命令：hmset user1 name “lin” sex “male” age “25” ，缓存用户 user1 的资料，姓名为 lin ，性别为男，年龄 25。</p> <p>map&lt;String, map&lt;&gt;&gt;</p></li> <li><p>list：</p> <p>可以做队列。往 list 队列里面 push 数据，然后再 pop 出来。</p> <p>比如订阅号列表, 关注人的信息推送到我的列表</p></li> <li><p>zset：</p> <p>可以用来做排行榜。</p></li> <li><p>set:</p> <p>微信的点赞用户</p> <p>抽奖参与用户  可以不重复的保存参与用户id, 还可以从中随机抽取中奖者</p> <p>社交圈: 可以求两个人的交集  微博共同关注的人</p> <p>推测可能认识的人: 求差集</p> <p>和list的区别就是, 不能有重复的元素, 可以用来存储某个人所有的关注者id</p></li></ul> <h1 id="常用命令"><a href="#常用命令" class="header-anchor">#</a> 常用命令</h1> <p>set key value 存储key-value结构的数据</p> <p>get key 获取对应key的value</p> <p>keys * 查看所有的key</p> <p>exists key 判断这个key是否存在</p> <p>del key 删除这个key</p> <p>type key 查看key的类型</p> <p>save 将当前内存的数据持久化 根目录的dump.db</p> <p>flushall 会将当前redis所有数据清空包括持久化数据</p> <p>fludb 清空一个分库的数据,不删除持久化数据</p> <p>mset/mget 批量操作</p> <p>expire key 可以对key添加超时过期的设定</p> <p>ttl key 可以查看key剩余时间, -2是超时 -1是永久数据</p> <h3 id="string类型的操作命令"><a href="#string类型的操作命令" class="header-anchor">#</a> String类型的操作命令</h3> <p><img src="/img/other/image-14b931f9bd654ff9a53be611bc0b9c65.png" alt="/img/other/image-14b931f9bd654ff9a53be611bc0b9c65.png"></p> <h3 id="list类型的操作命令"><a href="#list类型的操作命令" class="header-anchor">#</a> List类型的操作命令</h3> <p><img src="/img/other/image-4772d735d78f4247ac3ff410b66fedb5.png" alt="/img/other/image-4772d735d78f4247ac3ff410b66fedb5.png"></p> <h3 id="set类型的操作命令"><a href="#set类型的操作命令" class="header-anchor">#</a> Set类型的操作命令</h3> <p><img src="/img/other/image-0d55cc887d794685a46325cb27554934.png" alt="/img/other/image-0d55cc887d794685a46325cb27554934.png"></p> <h3 id="hash类型的操作命令"><a href="#hash类型的操作命令" class="header-anchor">#</a> Hash类型的操作命令</h3> <p><img src="/img/other/image-506e300dd397497cbe99be66bb2ffeab.png" alt="/img/other/image-506e300dd397497cbe99be66bb2ffeab.png"></p> <h3 id="zset类型的操作命令"><a href="#zset类型的操作命令" class="header-anchor">#</a> Zset类型的操作命令</h3> <p><img src="/img/other/image-6500961541b340bebb0059d8c382f12a.png" alt="/img/other/image-6500961541b340bebb0059d8c382f12a.png"></p> <h1 id="redis分布式"><a href="#redis分布式" class="header-anchor">#</a> redis分布式</h1> <p>分布式中数据分片计算:hash取余, hash一致性</p> <p>hash取余: 对key的hash值进行取余,再映射到redis节点上</p> <p>hash一致性: 散列计算,一个0-43亿的hash环, 将 redis节点映射到hash环上, key也映射到hash环上, key值顺时针寻找最近节点做映射</p> <h1 id="redis的优势"><a href="#redis的优势" class="header-anchor">#</a> redis的优势</h1> <ol><li>速度快, 因为数据都是存储在内存中</li> <li>支持丰富的数据类型, string, list, set, zset, hash</li> <li>支持事务, 操作都是原子性, 所谓的原子性就是对数据的更改要么全部执行, 要不不执行</li> <li>丰富的特性: 可用于缓存, 消息, 按照key设置过期时间, 过期后将会自动删除.</li> <li>单线程, 单进程, 采用IO多路复用技术</li></ol> <h1 id="redis可靠性"><a href="#redis可靠性" class="header-anchor">#</a> redis可靠性</h1> <p>redis可靠性也就是数据持久化的问题</p> <p>redis持久化分为<strong>AOF</strong>和<strong>RDB</strong>两种形式,</p> <p>AOF : 是备份操作记录. 因为是备份操作命令, 所以备份快 , 恢复慢</p> <p>RDB: 是快照的形式, 备份所有数据. 恢复数据比较快</p> <p>优缺点:</p> <p><strong>AOF</strong>: 日志的形式, 记录详细最多丢失一秒内的数据. 但是因为是日志级所以进程会持续进行可能占用资源, 恢复是需要根据日志操作进行恢复比较慢. 日志文件大</p> <p><strong>RDB</strong>: 快照的形式, 在设置的时间间隔内进行快照保存, 如果间隔时间过久则会丢失过多的数据. 一次保存是备份所有数据, 比较慢 ;但是由于保存的是数据的最新状态, 恢复时速度快</p> <p><strong>AOF文件重写</strong>: 由于AOF文件会越来越大, 里面会存在大量的重复命令或者可以合并的命令. 重写可以减少日志的尺寸, 减少占用, 加快数据恢复速度</p> <h1 id="redis的过期策略"><a href="#redis的过期策略" class="header-anchor">#</a> redis的过期策略</h1> <p>惰性删除: 当读写到这个过期的key时, 会触发惰性删除策略, 直接删除这个过期的key , 并按照key不存在处理. 过期的key如果没有触发会占用内存</p> <p>定期删除: 每隔一段时间就会对redis进行检查, 主动删除过期的key</p> <p>定时删除: 给每个key设置时间时, 为key创建一个定时器, 让定时器在key过期时执行删除</p> <h1 id="内存淘汰策略"><a href="#内存淘汰策略" class="header-anchor">#</a> 内存淘汰策略</h1> <p>当已用内存超过 maxmemory 限定时, 会触发主动清理策略, 也就是redis的内存回收/淘汰策略</p> <ol><li>noeviction(默认的) : 不会驱逐任何key</li> <li>allkeys-lru(常用): 对所有key使用LRU算法进行删除, 最近不常用的</li> <li>volatile-lru: 对所有设置了过期时间的key使用LRU算法进行删除</li> <li>allkeys-random: 对所有key随机删除</li> <li>volatile-random: 对所有设置了过期时间的key随机删除</li> <li>volatile-ttl: 删除马上要过期的key</li> <li>allkeys-lfu: 对所有key使用LFU算法进行删除</li> <li>volatile-lfu: 对所有设置了过期时间的key使用LFU算法进行删除</li></ol> <p>怎么配置修改?</p> <p>config set maxmemory-policy allkeys-lru  或者 修改配置文件</p> <h1 id="lru算法"><a href="#lru算法" class="header-anchor">#</a> LRU算法</h1> <p>Least Recently Used 的缩写, 即最近最少使用, 是一种常用的页面置换算法</p> <p>选择最近最久未使用的数据予以淘汰</p> <p>算法思想:</p> <ol><li>所谓缓存, 必须要有读+写两个操作, 按照命中率的思想考虑, 写操作+读操作时间复杂度都需要为0(1)</li> <li>特性要求
<ol><li>必须要有顺序之分, 一区分最近使用的和很久没有使用的数据排序</li> <li>写和读操作一次搞定</li> <li>如果容量满了要删除最不常用的数据, 每次新访问还要把新数据插入到队头</li></ol></li></ol> <p>查找快、插入快、删除快,还有先后顺序</p> <p>哈希链表  查找用哈希, 增删用链表</p> <p>手写算法   <a href="https://leetcode-cn.com/problems/lru-cache/" target="_blank" rel="noopener noreferrer">https://leetcode-cn.com/problems/lru-cache/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h1 id="redis的搭建模式"><a href="#redis的搭建模式" class="header-anchor">#</a> redis的搭建模式</h1> <p>主从模式, 哨兵模式, 集群模式</p> <h1 id="redis集群数据分片原理"><a href="#redis集群数据分片原理" class="header-anchor">#</a> redis集群数据分片原理</h1> <p>redis的数据分片原理是哈希槽</p> <p>redis集群有16384个槽道, 每个节点承担其中一部分</p> <p>哈希槽让在集群中增删节点变得容易, 只需要进行槽道的转移即可</p> <h1 id="hash一致性算法"><a href="#hash一致性算法" class="header-anchor">#</a> hash一致性算法</h1> <p>一致性算法将整个hash值控件组织成一个虚拟的圆环, 我们对key进行哈希计算, 使用哈希后的结果对2 ^ 32取模, hash环上必定有一个点与之对应, 依次确定此数据在环上的位置, 从此位置顺时针找到的第一台机器便是其应该定位到的服务器</p> <p>节点的增删只会影响定位环中相邻的一小部分数据, 具有较好的容错性和可扩展性</p> <h1 id="为啥redis集群分片没有使用hash一致性算法"><a href="#为啥redis集群分片没有使用hash一致性算法" class="header-anchor">#</a> 为啥redis集群分片没有使用hash一致性算法?</h1> <p>hash一致性有个问题就是数据倾斜.</p> <p>如果节点太少,并且分布不均匀, 会造成节点间数据不均的问题</p> <p>虚拟节点可以解决</p> <h1 id="集群的拓扑结构"><a href="#集群的拓扑结构" class="header-anchor">#</a> 集群的拓扑结构</h1> <p>无中心结构, 每个节点保存数据和整个集群的状态, 每个节点都和其他所有节点连接</p> <h1 id="redis数据更新"><a href="#redis数据更新" class="header-anchor">#</a> redis数据更新</h1> <p>当数据库数据需要更新时, 是先更新redis还是先更新数据库呢?</p> <p>先更新数据库再更新缓存, 这样无论哪一步出现问题,最多用户拿到旧数据</p> <p>从并发情况和数据一致性进行分析:</p> <p>如果两步都没有出错, 那么先更新数据库不会有一致性问题, 而先更新缓存在并发情况下会出现一致性问题</p> <p>如果两步中有其中一步出错, …</p> <p>先更新数据库加过期时间比较好</p> <h1 id="什么数据适合放在redis中"><a href="#什么数据适合放在redis中" class="header-anchor">#</a> 什么数据适合放在redis中?</h1> <p>个人认为:</p> <p>1.使用频繁的数据, 比如所有用户首页都展示活动信息或者频繁查询的重复数据, 更新不频繁但查询频繁的数据</p> <h1 id="redis实现分布式锁"><a href="#redis实现分布式锁" class="header-anchor">#</a> redis实现分布式锁</h1> <div class="language- extra-class"><pre class="language-text"><code>//普通命令SET lock_key random_value NX PX 5000//通过连接池使用redisPool.getResource().set(&quot;test02&quot;,&quot;测试2&quot;,SetParams.setParams().nx().px(5000));
</code></pre></div><p>NX表示只有键不存在时，才对键进行设置操作</p> <p>PX 5000 设置过期时间</p> <h2 id="使用redisson实现分布式锁"><a href="#使用redisson实现分布式锁" class="header-anchor">#</a> 使用redisson实现分布式锁</h2> <p>redisson实现分布式锁更优,它结合了java中lock本地锁,自动设置锁30s存活,并且看门狗自动锁续约,使用更方便</p> <p>解锁时尽量判断一下</p> <p><img src="/img/redis/1.png" alt=""></p> <h1 id="redis的内存穿透"><a href="#redis的内存穿透" class="header-anchor">#</a> redis的内存穿透</h1> <p>redis缓存穿透是因为当查询一个一定不存在的数据时, 由于缓存中不命中便会查询数据库, 查不到数据就不写入缓存, 这样每次查这个不存在的数据都会去查数据库, 造成缓存穿透.</p> <p>解决方法:</p> <p>1.布隆过滤</p> <p>对所有可能查询的参数以hash形式存储, 在控制层进行校验, 不符合则丢弃. 常见的还有使用布隆过滤器, 将所有可能存在的数据hash到一个bitmap中, 一个一定不存在的数据会被bitmap拦截掉, 从而避免对底层存储的查询</p> <p>2.缓存空对象</p> <p>当查询为空时, 将这个空对象进行缓存 , 过期时间给短一些</p> <h1 id="缓存击穿"><a href="#缓存击穿" class="header-anchor">#</a> 缓存击穿</h1> <p>key对应的数据存在，但在redis中过期，此时若有大量并发请求过来，这些请求发现缓存过期一般都会从后端DB加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端DB压垮。</p> <p>解决方法:</p> <p>1.使用互斥锁(mutex key)</p> <p>当判断失效时(value为null), 不立即去读数据库, 使用redis的SETNX存储一个标识key, 如果存储成功了, 则读数据库, 写入缓存, 删除这个标识key ; 如果存储标识key失败了, 意味着有其他线程已经在做读库操作了, 让当前线程sleep一段时间后重试</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> value <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//代表缓存值过期</span>
          <span class="token comment">//设置3min的超时，防止del操作失败的时候，下次缓存过期一直不能load db</span>
		      <span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">setnx</span><span class="token punctuation">(</span>key_mutex<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
							 <span class="token comment">//代表设置成功</span>
               value <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
               redis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> expire_secs<span class="token punctuation">)</span><span class="token punctuation">;</span>
               redis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>key_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  
              <span class="token comment">//这个时候代表同时候的其他线程已经load db并回设到缓存了，这时候重试获取缓存值即可</span>
	             <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//重试</span>
          <span class="token punctuation">}</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> value<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre></div><h1 id="缓存雪崩"><a href="#缓存雪崩" class="header-anchor">#</a> 缓存雪崩</h1> <p>与击穿的区别在于,是大量的key失效, 一旦缓存大量丢失缓存数据,就造成海量请求瞬间进入数据库,导致数据库崩溃–雪崩;redis出现雪崩,只需要恢复数据(持久化),memoryCache出现雪崩,只能停止服务手动将数据恢复到内存中,继续提供服务</p> <p>解决方法:</p> <p>1.线程加锁, 但是对出现一线程执行多线程等待 , 影响并发</p> <p>2.在原有失效时间上加个随机值, 让每个key的过期时间尽量错开, 避免集体失效</p> <p>3.做二级缓存, 或者双缓存机制 做两份缓存A和B, B不设失效时间, 这样当A失效后拿B的数据去返回, 同时异步启动一个更新线程, 将更新的数据同步到A和B</p> <h1 id="其余"><a href="#其余" class="header-anchor">#</a> 其余</h1> <p>https://mp.weixin.qq.com/s/TZ6sRuiClFJf6tMKE0Cq7w</p></div></div> <!----> <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/0e9f6d/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">索引</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/0e9f6d/" class="prev">索引</a></span> <!----></p></div></div></div> <!----></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>张大喵</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9ac200f5.js" defer></script><script src="/assets/js/2.f08c2e94.js" defer></script><script src="/assets/js/16.7aa17999.js" defer></script>
  </body>
</html>
