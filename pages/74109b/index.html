<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>springboot整合多数据源 | 跳跳猪</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.jpg">
    <meta name="description" content="吃得好，睡得好">
    
    <link rel="preload" href="/assets/css/0.styles.542f065b.css" as="style"><link rel="preload" href="/assets/js/app.9eea15e6.js" as="script"><link rel="preload" href="/assets/js/2.f08c2e94.js" as="script"><link rel="preload" href="/assets/js/12.422bbc2d.js" as="script"><link rel="prefetch" href="/assets/js/10.12e67808.js"><link rel="prefetch" href="/assets/js/11.d3df5b45.js"><link rel="prefetch" href="/assets/js/13.0e8e1751.js"><link rel="prefetch" href="/assets/js/14.1cefb67a.js"><link rel="prefetch" href="/assets/js/15.6db16ffa.js"><link rel="prefetch" href="/assets/js/16.2888c1b2.js"><link rel="prefetch" href="/assets/js/17.465d0651.js"><link rel="prefetch" href="/assets/js/18.64474359.js"><link rel="prefetch" href="/assets/js/19.23f3e7d6.js"><link rel="prefetch" href="/assets/js/20.de24a1e8.js"><link rel="prefetch" href="/assets/js/21.b6ad6f40.js"><link rel="prefetch" href="/assets/js/3.72784d31.js"><link rel="prefetch" href="/assets/js/4.2e894fd2.js"><link rel="prefetch" href="/assets/js/5.5e2ac693.js"><link rel="prefetch" href="/assets/js/6.b2a60611.js"><link rel="prefetch" href="/assets/js/7.adedf7f2.js"><link rel="prefetch" href="/assets/js/8.ec28826b.js"><link rel="prefetch" href="/assets/js/9.e76d8e43.js">
    <link rel="stylesheet" href="/assets/css/0.styles.542f065b.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://excalidraw.com/apple-touch-icon.png" alt="跳跳猪" class="logo"> <span class="site-name can-hide">跳跳猪</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/md/java/JAVA基础.html" class="nav-link">JAVA</a></div><div class="nav-item"><a href="/md/notes/" class="nav-link">测试</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="提示语" class="dropdown-title"><!----> <span class="title" style="display:;">测试下拉菜单</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/notes/" class="nav-link">菜单1</a></li><li class="dropdown-item"><!----> <a href="/md/notes/" class="nav-link">菜单2</a></li><li class="dropdown-item"><h4>多次菜单</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/notes/" class="nav-link">多级菜单1</a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/md/java/JAVA基础.html" class="nav-link">JAVA</a></div><div class="nav-item"><a href="/md/notes/" class="nav-link">测试</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="提示语" class="dropdown-title"><!----> <span class="title" style="display:;">测试下拉菜单</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/notes/" class="nav-link">菜单1</a></li><li class="dropdown-item"><!----> <a href="/md/notes/" class="nav-link">菜单2</a></li><li class="dropdown-item"><h4>多次菜单</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/notes/" class="nav-link">多级菜单1</a></li></ul></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JAVA</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/dc132d/" class="sidebar-link">JAVA基础</a></li><li><a href="/pages/d9f5d1/" class="sidebar-link">java8新特性</a></li><li><a href="/pages/b4de67/" class="sidebar-link">JVM</a></li><li><a href="/pages/4ef7a0/" class="sidebar-link">Spring</a></li><li><a href="/pages/4bcf6f/" class="sidebar-link">SpringBoot</a></li><li><a href="/pages/bf25fe/" class="sidebar-link">Gateway网关</a></li><li><a href="/pages/7a7d4b/" class="sidebar-link">并发常见</a></li><li><a href="/pages/fd10b9/" class="sidebar-link">分布式事务</a></li><li><a href="/pages/74109b/" aria-current="page" class="active sidebar-link">springboot整合多数据源</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/74109b/#简介" class="sidebar-link">简介：</a></li><li class="sidebar-sub-header level2"><a href="/pages/74109b/#版本" class="sidebar-link">版本：</a></li><li class="sidebar-sub-header level2"><a href="/pages/74109b/#一、分包方式实现" class="sidebar-link">一、分包方式实现：</a></li><li class="sidebar-sub-header level2"><a href="/pages/74109b/#二、aop实现" class="sidebar-link">二、AOP实现：</a></li><li class="sidebar-sub-header level2"><a href="/pages/74109b/#三、使用注解整合" class="sidebar-link">三、使用注解整合</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/74109b/#主要依赖" class="sidebar-link">主要依赖</a></li><li class="sidebar-sub-header level3"><a href="/pages/74109b/#application-yml-配置文件" class="sidebar-link">application.yml 配置文件</a></li><li class="sidebar-sub-header level3"><a href="/pages/74109b/#给使用非默认数据源添加注解-ds" class="sidebar-link">给使用非默认数据源添加注解@DS</a></li></ul></li></ul></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>数据结构和算法</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>md</span></li><li data-v-06225672><span data-v-06225672>java</span></li></ul> <div class="info" data-v-06225672><!----> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-10-27</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">springboot整合多数据源<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="springboot整合多数据源"><a href="#springboot整合多数据源" class="header-anchor">#</a> springboot整合多数据源</h1> <h1 id="springboot整合多数据源-2"><a href="#springboot整合多数据源-2" class="header-anchor">#</a> springboot整合多数据源</h1> <p>参考链接: https://www.cnblogs.com/aizen-sousuke/p/11756279.html 参考链接: https://blog.csdn.net/tuesdayma/article/details/81081666</p> <h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介：</h2> <p>随着并发量的不断增加，显然单个数据库已经承受不了高并发带来的压力。一个项目使用多个数据库（无论是主从复制- - 读写分离还是分布式数据库结构）的重要性变得越来越明显。传统项目中（个人对传统项目的理解就是所有的业务模块都在一个tomcat中完成，多个相同的tomcat集群也可认为是传统项目）整合多数据源有两种方法：分包和AOP。</p> <h2 id="版本"><a href="#版本" class="header-anchor">#</a> 版本：</h2> <p>springboot：1.5.9.RELEASE mariadb：5.7</p> <h2 id="一、分包方式实现"><a href="#一、分包方式实现" class="header-anchor">#</a> 一、分包方式实现：</h2> <p>springboot+mybatis</p> <p><strong>1、在application.properties中配置两个数据库：</strong></p> <div class="language- extra-class"><pre class="language-text"><code>## test1 databasespring.datasource.test1.url=jdbc:mysql://localhost:3307/multipledatasource1?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC&amp;useSSL=falsespring.datasource.test1.username=rootspring.datasource.test1.password=rootspring.datasource.test1.driver-class-name=com.mysql.cj.jdbc.Driver## test2 databasespring.datasource.test2.url=jdbc:mysql://localhost:3307/multipledatasource2?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC&amp;useSSL=falsespring.datasource.test2.username=rootspring.datasource.test2.password=rootspring.datasource.test2.driver-class-name=com.mysql.cj.jdbc.Driver12345678910
</code></pre></div><p><strong>2、建立连个数据源的配置文件：</strong></p> <p>springbooot中的参数可以参考上一篇博客（不定期更新中）：https://blog.csdn.net/tuesdayma/article/details/81029539</p> <p>第一个配置文件：</p> <div class="language- extra-class"><pre class="language-text"><code>//表示这个类为一个配置类@Configuration// 配置mybatis的接口类放的地方@MapperScan(basePackages = &quot;com.mzd.multipledatasources.mapper.test01&quot;, sqlSessionFactoryRef = &quot;test1SqlSessionFactory&quot;)public class DataSourceConfig1 {    // 将这个对象放入Spring容器中    @Bean(name = &quot;test1DataSource&quot;)    // 表示这个数据源是默认数据源    @Primary    // 读取application.properties中的配置参数映射成为一个对象    // prefix表示参数的前缀    @ConfigurationProperties(prefix = &quot;spring.datasource.test1&quot;)    public DataSource getDateSource1() {        return DataSourceBuilder.create().build();    }    @Bean(name = &quot;test1SqlSessionFactory&quot;)    // 表示这个数据源是默认数据源    @Primary    // @Qualifier表示查找Spring容器中名字为test1DataSource的对象    public SqlSessionFactory test1SqlSessionFactory(@Qualifier(&quot;test1DataSource&quot;) DataSource datasource)            throws Exception {        SqlSessionFactoryBean bean = new SqlSessionFactoryBean();        bean.setDataSource(datasource);        bean.setMapperLocations(                // 设置mybatis的xml所在位置                new PathMatchingResourcePatternResolver().getResources(&quot;classpath*:mapping/test01/*.xml&quot;));        return bean.getObject();    }    @Bean(&quot;test1SqlSessionTemplate&quot;)    // 表示这个数据源是默认数据源    @Primary    public SqlSessionTemplate test1sqlsessiontemplate(            @Qualifier(&quot;test1SqlSessionFactory&quot;) SqlSessionFactory sessionfactory) {        return new SqlSessionTemplate(sessionfactory);    }}123456789101112131415161718192021222324252627282930313233343536
</code></pre></div><p>第二个配置文件：</p> <div class="language- extra-class"><pre class="language-text"><code>@Configuration@MapperScan(basePackages = &quot;com.mzd.multipledatasources.mapper.test02&quot;, sqlSessionFactoryRef = &quot;test2SqlSessionFactory&quot;)public class DataSourceConfig2 {    @Bean(name = &quot;test2DataSource&quot;)    @ConfigurationProperties(prefix = &quot;spring.datasource.test2&quot;)    public DataSource getDateSource2() {        return DataSourceBuilder.create().build();    }    @Bean(name = &quot;test2SqlSessionFactory&quot;)    public SqlSessionFactory test2SqlSessionFactory(@Qualifier(&quot;test2DataSource&quot;) DataSource datasource)            throws Exception {        SqlSessionFactoryBean bean = new SqlSessionFactoryBean();        bean.setDataSource(datasource);        bean.setMapperLocations(                new PathMatchingResourcePatternResolver().getResources(&quot;classpath*:mapping/test02/*.xml&quot;));        return bean.getObject();    }    @Bean(&quot;test2SqlSessionTemplate&quot;)    public SqlSessionTemplate test2sqlsessiontemplate(            @Qualifier(&quot;test2SqlSessionFactory&quot;) SqlSessionFactory sessionfactory) {        return new SqlSessionTemplate(sessionfactory);    }}123456789101112131415161718192021222324
</code></pre></div><p>注意：</p> <p>1、@Primary这个注解必须要加，因为不加的话spring将分不清楚那个为主数据源（默认数据源）</p> <p>2、mapper的接口、xml形式以及dao层都需要两个分开，目录如图：</p> <p><a href="https://img-blog.csdn.net/20180717154735494?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3R1ZXNkYXltYQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" target="_blank" rel="noopener noreferrer">https://img-blog.csdn.net/20180717154735494?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3R1ZXNkYXltYQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>3、bean.setMapperLocations(new PathMatchingResourcePatternResolver().getResources(“XXXX”));mapper的xml形式文件位置必须要配置，不然将报错：no statement （这种错误也可能是mapper的xml中，namespace与项目的路径不一致导致的，具体看情况吧，注意一下就行，问题不大的）</p> <p>4、在service层中根据不同的业务注入不同的dao层。</p> <p>5、如果是主从复制- -读写分离：比如test01中负责增删改，test02中负责查询。但是需要注意的是负责增删改的数据库必须是主库（master）</p> <p>6、如果是分布式结构的话，不同模块操作各自的数据库就好，test01包下全是test01业务，test02全是test02业务，但是如果test01中掺杂着test02的编辑操作，这时候将会产生事务问题：即test01中的事务是没法控制test02的事务的，这个问题在之后的博客中会解决。</p> <h2 id="二、aop实现"><a href="#二、aop实现" class="header-anchor">#</a> 二、AOP实现：</h2> <p><strong>简介：</strong> 用这种方式实现多数据源的前提必须要清楚两个知识点：AOP原理和AbstractRoutingDataSource抽象类。</p> <p>**1、AOP：**这个东西。。。不切当的说就是相当于拦截器，只要满足要求的都会被拦截过来，然后进行一些列的操作。具体需要自己去体会。。。</p> <p>**2、AbstractRoutingDataSource：**这个类是实现多数据源的关键，他的作用就是动态切换数据源，实质：有多少个数据源就存多少个数据源在targetDataSources（是AbstractRoutingDataSource的一个map类型的属性，其中value为每个数据源，key表示每个数据源的名字）这个属性中，然后根据determineCurrentLookupKey（）这个方法获取当前数据源在map中的key值，然后determineTargetDataSource（）方法中动态获取当前数据源，如果当前数据源不存并且默认数据源也不存在就抛出异常。</p> <div class="language- extra-class"><pre class="language-text"><code>public abstract class AbstractRoutingDataSource extends AbstractDataSource implements InitializingBean {    //多数据源map集合    private Map&lt;Object, Object&gt; targetDataSources;    //默认数据源    private Object defaultTargetDataSource;    //其实就是targetDataSources，后面的afterPropertiesSet（）方法会将targetDataSources赋值给resolvedDataSources    private Map&lt;Object, DataSource&gt; resolvedDataSources;    private DataSource resolvedDefaultDataSource;    public void setTargetDataSources(Map&lt;Object, Object&gt; targetDataSources) {        this.targetDataSources = targetDataSources;    }    protected DataSource determineTargetDataSource() {        Assert.notNull(this.resolvedDataSources, &quot;DataSource router not initialized&quot;);        Object lookupKey = this.determineCurrentLookupKey();        DataSource dataSource = (DataSource)this.resolvedDataSources.get(lookupKey);        if (dataSource == null &amp;&amp; (this.lenientFallback || lookupKey == null)) {            dataSource = this.resolvedDefaultDataSource;        }        if (dataSource == null) {            throw new IllegalStateException(&quot;Cannot determine target DataSource for lookup key [&quot; + lookupKey + &quot;]&quot;);        } else {            return dataSource;        }    }    protected abstract Object determineCurrentLookupKey();}
</code></pre></div><p><strong>具体实现：</strong></p> <p>**1、定义一个动态数据源：**继承AbstractRoutingDataSource 抽象类，并重写determineCurrentLookupKey（）方法</p> <div class="language- extra-class"><pre class="language-text"><code>public class DynamicDataSource extends AbstractRoutingDataSource {    @Override    protected Object determineCurrentLookupKey() {        DataSourceType.DataBaseType dataBaseType = DataSourceType.getDataBaseType();        return dataBaseType;    }}
</code></pre></div><p><strong>2、创建一个切换数据源类型的类：</strong> ThreadLocal这个知识点可以参考我的博客：https://blog.csdn.net/tuesdayma/article/details/74841657 就是为了线程的安全性，每个线程之间不会相互影响。</p> <div class="language- extra-class"><pre class="language-text"><code>public class DataSourceType {    public enum DataBaseType {        TEST01, TEST02    }    // 使用ThreadLocal保证线程安全    private static final ThreadLocal&lt;DataBaseType&gt; TYPE = new ThreadLocal&lt;DataBaseType&gt;();    // 往当前线程里设置数据源类型    public static void setDataBaseType(DataBaseType dataBaseType) {        if (dataBaseType == null) {            throw new NullPointerException();        }        System.err.println(&quot;[将当前数据源改为]：&quot; + dataBaseType);        TYPE.set(dataBaseType);    }    // 获取数据源类型    public static DataBaseType getDataBaseType() {        DataBaseType dataBaseType = TYPE.get() == null ? DataBaseType.TEST01 : TYPE.get();        System.err.println(&quot;[获取当前数据源的类型为]：&quot; + dataBaseType);        return dataBaseType;    }    // 清空数据类型    public static void clearDataBaseType() {        TYPE.remove();    }}
</code></pre></div><p>**3、定义多个数据源：**怎么定义就不多说了，和方法一是一样的，主要是将定义好的多个数据源放在动态数据源中。</p> <div class="language- extra-class"><pre class="language-text"><code>@Configuration@MapperScan(basePackages = &quot;com.mzd.multipledatasources.mapper&quot;, sqlSessionFactoryRef = &quot;SqlSessionFactory&quot;)public class DataSourceConfig {    @Primary    @Bean(name = &quot;test1DataSource&quot;)    @ConfigurationProperties(prefix = &quot;spring.datasource.test1&quot;)    public DataSource getDateSource1() {        return DataSourceBuilder.create().build();    }    @Bean(name = &quot;test2DataSource&quot;)    @ConfigurationProperties(prefix = &quot;spring.datasource.test2&quot;)    public DataSource getDateSource2() {        return DataSourceBuilder.create().build();    }    @Bean(name = &quot;dynamicDataSource&quot;)    public DynamicDataSource DataSource(@Qualifier(&quot;test1DataSource&quot;) DataSource test1DataSource,            @Qualifier(&quot;test2DataSource&quot;) DataSource test2DataSource) {        Map&lt;Object, Object&gt; targetDataSource = new HashMap&lt;&gt;();        targetDataSource.put(DataSourceType.DataBaseType.TEST01, test1DataSource);        targetDataSource.put(DataSourceType.DataBaseType.TEST02, test2DataSource);        DynamicDataSource dataSource = new DynamicDataSource();        dataSource.setTargetDataSources(targetDataSource);        dataSource.setDefaultTargetDataSource(test1DataSource);        return dataSource;    }    @Bean(name = &quot;SqlSessionFactory&quot;)    public SqlSessionFactory test1SqlSessionFactory(@Qualifier(&quot;dynamicDataSource&quot;) DataSource dynamicDataSource)            throws Exception {        SqlSessionFactoryBean bean = new SqlSessionFactoryBean();        bean.setDataSource(dynamicDataSource);        bean.setMapperLocations(                new PathMatchingResourcePatternResolver().getResources(&quot;classpath*:mapping/*.xml&quot;));        return bean.getObject();    }}
</code></pre></div><p>**4、定义AOP：**就是不同业务切换不同数据库的入口。如果觉得execution太长不愿意写，就可以定义一个注解来实现。可参考于我的博客：https://blog.csdn.net/tuesdayma/article/details/79704238</p> <div class="language- extra-class"><pre class="language-text"><code>@Aspect@Componentpublic class DataSourceAop {    @Before(&quot;execution(* com.mzd.multipledatasources.service..*.test01*(..))&quot;)    public void setDataSource2test01() {        System.err.println(&quot;test01业务&quot;);        DataSourceType.setDataBaseType(DataBaseType.TEST01);    }    @Before(&quot;execution(* com.mzd.multipledatasources.service..*.test02*(..))&quot;)    public void setDataSource2test02() {        System.err.println(&quot;test02业务&quot;);        DataSourceType.setDataBaseType(DataBaseType.TEST02);    }}
</code></pre></div><p><strong>整体目录如图：</strong></p> <p><a href="https://img-blog.csdn.net/20180717181055626?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3R1ZXNkYXltYQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" target="_blank" rel="noopener noreferrer">https://img-blog.csdn.net/20180717181055626?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3R1ZXNkYXltYQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="三、使用注解整合"><a href="#三、使用注解整合" class="header-anchor">#</a> 三、使用注解整合</h2> <p>springboot+druid+mybatisplus</p> <h3 id="主要依赖"><a href="#主要依赖" class="header-anchor">#</a> 主要依赖</h3> <div class="language- extra-class"><pre class="language-text"><code>spring-boot-starter-webmybatis-plus-boot-starterdynamic-datasource-spring-boot-starter # 配置动态数据源druid-spring-boot-starter # 阿里的数据库连接池mysql-connector-javalombok
</code></pre></div><p>pom.xml文件</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;        xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;   &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;   &lt;parent&gt;       &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;       &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;       &lt;version&gt;2.1.9.RELEASE&lt;/version&gt;       &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;   &lt;/parent&gt;   &lt;groupId&gt;com.example&lt;/groupId&gt;   &lt;artifactId&gt;mutipledatasource2&lt;/artifactId&gt;   &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;   &lt;name&gt;mutipledatasource2&lt;/name&gt;   &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;   &lt;properties&gt;       &lt;java.version&gt;1.8&lt;/java.version&gt;   &lt;/properties&gt;   &lt;dependencies&gt;       &lt;dependency&gt;           &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;           &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;       &lt;/dependency&gt;       &lt;dependency&gt;           &lt;groupId&gt;com.baomidou&lt;/groupId&gt;           &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;           &lt;version&gt;3.2.0&lt;/version&gt;       &lt;/dependency&gt;       &lt;dependency&gt;           &lt;groupId&gt;com.baomidou&lt;/groupId&gt;           &lt;artifactId&gt;dynamic-datasource-spring-boot-starter&lt;/artifactId&gt;           &lt;version&gt;2.5.6&lt;/version&gt;       &lt;/dependency&gt;       &lt;dependency&gt;           &lt;groupId&gt;mysql&lt;/groupId&gt;           &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;           &lt;scope&gt;runtime&lt;/scope&gt;       &lt;/dependency&gt;       &lt;dependency&gt;           &lt;groupId&gt;com.alibaba&lt;/groupId&gt;           &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;           &lt;version&gt;1.1.20&lt;/version&gt;       &lt;/dependency&gt;       &lt;dependency&gt;           &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;           &lt;artifactId&gt;lombok&lt;/artifactId&gt;           &lt;optional&gt;true&lt;/optional&gt;       &lt;/dependency&gt;       &lt;dependency&gt;           &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;           &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;           &lt;scope&gt;test&lt;/scope&gt;       &lt;/dependency&gt;   &lt;/dependencies&gt;   &lt;build&gt;       &lt;plugins&gt;           &lt;plugin&gt;               &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;               &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;           &lt;/plugin&gt;       &lt;/plugins&gt;   &lt;/build&gt;   &lt;profiles&gt;       &lt;profile&gt;           &lt;id&gt;local1&lt;/id&gt;           &lt;properties&gt;               &lt;profileActive&gt;local1&lt;/profileActive&gt;           &lt;/properties&gt;           &lt;activation&gt;               &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;           &lt;/activation&gt;       &lt;/profile&gt;       &lt;profile&gt;           &lt;id&gt;local2&lt;/id&gt;           &lt;properties&gt;               &lt;profileActive&gt;local2&lt;/profileActive&gt;           &lt;/properties&gt;       &lt;/profile&gt;   &lt;/profiles&gt;&lt;/project&gt;
</code></pre></div><h3 id="application-yml-配置文件"><a href="#application-yml-配置文件" class="header-anchor">#</a> application.yml 配置文件</h3> <div class="language- extra-class"><pre class="language-text"><code>server:  port: 8080spring:  datasource:    dynamic:      primary: db1 # 配置默认数据库      datasource:        db1: # 数据源1配置          url: jdbc:mysql://localhost:3306/db1?characterEncoding=utf8&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=GMT%2B8          username: root          password: root          driver-class-name: com.mysql.cj.jdbc.Driver        db2: # 数据源2配置          url: jdbc:mysql://localhost:3306/db2?characterEncoding=utf8&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=GMT%2B8          username: root          password: root          driver-class-name: com.mysql.cj.jdbc.Driver      durid:        initial-size: 1        max-active: 20        min-idle: 1        max-wait: 60000  autoconfigure:    exclude:  com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure # 去除druid配置
</code></pre></div><p><code>DruidDataSourceAutoConfigure</code>会注入一个<code>DataSourceWrapper</code>，其会在原生的<code>spring.datasource</code>下找 url, username, password 等。动态数据源 URL 等配置是在 dynamic 下，因此需要排除，否则会报错。排除方式有两种，一种是上述配置文件排除，还有一种可以在项目启动类排除：</p> <div class="language- extra-class"><pre class="language-text"><code>@SpringBootApplication(exclude = DruidDataSourceAutoConfigure.class)public class Application {  public static void main(String[] args) {    SpringApplication.run(Application.class, args);  }}
</code></pre></div><h3 id="给使用非默认数据源添加注解-ds"><a href="#给使用非默认数据源添加注解-ds" class="header-anchor">#</a> 给使用非默认数据源添加注解@DS</h3> <p><code>@DS</code> 可以注解在方法上和类上，同时存在方法注解优先于类上注解。 注解在 service 实现或 mapper 接口方法上，不要同时在 service 和 mapper 注解。</p> <div class="language- extra-class"><pre class="language-text"><code>@DS(&quot;db2&quot;) public interface UserMapper extends BaseMapper&lt;User&gt; {}@Service@DS(&quot;db2&quot;)public class ModelServiceImpl extends ServiceImpl&lt;ModelMapper, Model&gt; implements IModelService {}  @Select(&quot;SELECT * FROM user&quot;)  @DS(&quot;db2&quot;)  List&lt;User&gt; selectAll();
</code></pre></div><h1 id="springboot配置多数据源mybatis配置失效问题"><a href="#springboot配置多数据源mybatis配置失效问题" class="header-anchor">#</a> springboot配置多数据源mybatis配置失效问题</h1> <p>参考链接: https://blog.csdn.net/weixin_30256901/article/details/99267676 参考链接: https://blog.csdn.net/qq_38380025/article/details/84636408</p> <p>mybatis配置</p> <div class="language- extra-class"><pre class="language-text"><code>#开启驼峰映射mybatis.configuration.map-underscore-to-camel-case=true#开启打印sqlmybatis.configuration.log-impl=org.apache.ibatis.logging.stdout.StdOutImpl
</code></pre></div><p>失效处理</p> <div class="language- extra-class"><pre class="language-text"><code>    @Bean    @ConfigurationProperties(prefix = &quot;mybatis.configuration&quot;)    public org.apache.ibatis.session.Configuration globalConfiguration() {        return new org.apache.ibatis.session.Configuration();    }    @Bean    public SqlSessionFactory sqlSessionFactory(org.apache.ibatis.session.Configuration config) throws Exception {        SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean();        sqlSessionFactoryBean.setDataSource(myRoutingDataSource);        sqlSessionFactoryBean.setTypeAliasesPackage(&quot;com.bling.dab.domain&quot;);        sqlSessionFactoryBean.setConfiguration(config);        sqlSessionFactoryBean.setMapperLocations(new PathMatchingResourcePatternResolver().getResources(&quot;classpath:mapper/*.xml&quot;));        return sqlSessionFactoryBean.getObject();
</code></pre></div><p>问题解决，失效原因是配置多数据源，自定义的sqlsessionFactory不会加载mybatis配置，而单数据源的sqlsessionFactory不是自定义的默认去加载了mybatis配置</p></div></div> <!----> <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/fd10b9/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">分布式事务</div></a> <a href="/pages/682583/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">HashMap</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/fd10b9/" class="prev">分布式事务</a></span> <span class="next"><a href="/pages/682583/">HashMap</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>张大喵</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9eea15e6.js" defer></script><script src="/assets/js/2.f08c2e94.js" defer></script><script src="/assets/js/12.422bbc2d.js" defer></script>
  </body>
</html>
