<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>并发常见 | 跳跳猪</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.jpg">
    <meta name="description" content="吃得好，睡得好">
    
    <link rel="preload" href="/assets/css/0.styles.3105bdb2.css" as="style"><link rel="preload" href="/assets/js/app.5f14dbf8.js" as="script"><link rel="preload" href="/assets/js/2.067d241c.js" as="script"><link rel="preload" href="/assets/js/4.ba4eeead.js" as="script"><link rel="prefetch" href="/assets/js/10.d6cb8434.js"><link rel="prefetch" href="/assets/js/11.38a73673.js"><link rel="prefetch" href="/assets/js/12.b04b2b51.js"><link rel="prefetch" href="/assets/js/13.0eff8c2d.js"><link rel="prefetch" href="/assets/js/14.e27f2763.js"><link rel="prefetch" href="/assets/js/15.2d3645e9.js"><link rel="prefetch" href="/assets/js/16.5c1a7a2a.js"><link rel="prefetch" href="/assets/js/17.2dd1f96b.js"><link rel="prefetch" href="/assets/js/18.c953d6f2.js"><link rel="prefetch" href="/assets/js/19.2fb246ce.js"><link rel="prefetch" href="/assets/js/20.fe831066.js"><link rel="prefetch" href="/assets/js/21.6bfd145a.js"><link rel="prefetch" href="/assets/js/22.5ff5d390.js"><link rel="prefetch" href="/assets/js/23.8b09df6f.js"><link rel="prefetch" href="/assets/js/24.5e4dd246.js"><link rel="prefetch" href="/assets/js/25.1f2c6c51.js"><link rel="prefetch" href="/assets/js/26.3d059273.js"><link rel="prefetch" href="/assets/js/27.6e261a40.js"><link rel="prefetch" href="/assets/js/28.0b3a9881.js"><link rel="prefetch" href="/assets/js/29.4c8ce51a.js"><link rel="prefetch" href="/assets/js/3.ed1f6ba3.js"><link rel="prefetch" href="/assets/js/30.3c980e66.js"><link rel="prefetch" href="/assets/js/31.866e01e5.js"><link rel="prefetch" href="/assets/js/32.2a4b8f6e.js"><link rel="prefetch" href="/assets/js/33.1e350a87.js"><link rel="prefetch" href="/assets/js/34.4e16be50.js"><link rel="prefetch" href="/assets/js/35.ff78fdc7.js"><link rel="prefetch" href="/assets/js/36.5309a26c.js"><link rel="prefetch" href="/assets/js/37.6bb967ab.js"><link rel="prefetch" href="/assets/js/38.668c29cc.js"><link rel="prefetch" href="/assets/js/39.8bfc961e.js"><link rel="prefetch" href="/assets/js/40.f5d3680b.js"><link rel="prefetch" href="/assets/js/41.2210a479.js"><link rel="prefetch" href="/assets/js/42.8d83a6db.js"><link rel="prefetch" href="/assets/js/43.ea90360d.js"><link rel="prefetch" href="/assets/js/44.bb77b4d4.js"><link rel="prefetch" href="/assets/js/45.e5c3d20a.js"><link rel="prefetch" href="/assets/js/46.0a1df14d.js"><link rel="prefetch" href="/assets/js/47.82c73dee.js"><link rel="prefetch" href="/assets/js/48.288e3334.js"><link rel="prefetch" href="/assets/js/49.197ec2c5.js"><link rel="prefetch" href="/assets/js/5.47cbaef3.js"><link rel="prefetch" href="/assets/js/50.1a886dde.js"><link rel="prefetch" href="/assets/js/51.5374f369.js"><link rel="prefetch" href="/assets/js/52.0ad2ec84.js"><link rel="prefetch" href="/assets/js/53.0c544cad.js"><link rel="prefetch" href="/assets/js/54.947f6be0.js"><link rel="prefetch" href="/assets/js/55.34e6a7c5.js"><link rel="prefetch" href="/assets/js/56.4bc00463.js"><link rel="prefetch" href="/assets/js/57.4b8c3100.js"><link rel="prefetch" href="/assets/js/58.d7a8f09a.js"><link rel="prefetch" href="/assets/js/59.1e5dfa7d.js"><link rel="prefetch" href="/assets/js/6.37eb9987.js"><link rel="prefetch" href="/assets/js/60.57e18718.js"><link rel="prefetch" href="/assets/js/61.badfe69f.js"><link rel="prefetch" href="/assets/js/62.f0da52e7.js"><link rel="prefetch" href="/assets/js/63.b6fdf9e1.js"><link rel="prefetch" href="/assets/js/64.d1f4e70b.js"><link rel="prefetch" href="/assets/js/65.d5b12498.js"><link rel="prefetch" href="/assets/js/66.1b7a04c7.js"><link rel="prefetch" href="/assets/js/67.26a278e3.js"><link rel="prefetch" href="/assets/js/68.8ed1d2ee.js"><link rel="prefetch" href="/assets/js/69.c88fb620.js"><link rel="prefetch" href="/assets/js/7.b27f8e0c.js"><link rel="prefetch" href="/assets/js/70.c2606b2f.js"><link rel="prefetch" href="/assets/js/8.d9eb6281.js"><link rel="prefetch" href="/assets/js/9.f92e08f0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3105bdb2.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://excalidraw.com/apple-touch-icon.png" alt="跳跳猪" class="logo"> <span class="site-name can-hide">跳跳猪</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/md/java/JAVA基础.html" class="nav-link">JAVA</a></div><div class="nav-item"><a href="/md/database/mysql/MySql操作.html" class="nav-link">数据库</a></div><div class="nav-item"><a href="/md/opSystem/linux/linux操作笔记.html" class="nav-link">操作系统</a></div><div class="nav-item"><a href="/md/middleware/mq/消息队列.html" class="nav-link">中间件</a></div><div class="nav-item"><a href="/md/tool/docker/docker.html" class="nav-link">开发工具</a></div><div class="nav-item"><a href="/md/designPattern/" class="nav-link">设计模式</a></div><div class="nav-item"><a href="/md/netty/BIO、NIO、AIO.html" class="nav-link">netty</a></div><div class="nav-item"><a href="/md/DDD/小傅哥案例学习打卡/DDD抽奖系统学习打卡🚀 day 1.html" class="nav-link">DDD</a></div><div class="nav-item"><a href="/md/other/面试题.html" class="nav-link">other</a></div><div class="nav-item"><a href="/md/notes/" class="nav-link">测试</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="提示语" class="dropdown-title"><!----> <span class="title" style="display:;">测试下拉菜单</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/notes/" class="nav-link">菜单1</a></li><li class="dropdown-item"><!----> <a href="/md/notes/" class="nav-link">菜单2</a></li><li class="dropdown-item"><h4>多次菜单</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/notes/" class="nav-link">多级菜单1</a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/md/java/JAVA基础.html" class="nav-link">JAVA</a></div><div class="nav-item"><a href="/md/database/mysql/MySql操作.html" class="nav-link">数据库</a></div><div class="nav-item"><a href="/md/opSystem/linux/linux操作笔记.html" class="nav-link">操作系统</a></div><div class="nav-item"><a href="/md/middleware/mq/消息队列.html" class="nav-link">中间件</a></div><div class="nav-item"><a href="/md/tool/docker/docker.html" class="nav-link">开发工具</a></div><div class="nav-item"><a href="/md/designPattern/" class="nav-link">设计模式</a></div><div class="nav-item"><a href="/md/netty/BIO、NIO、AIO.html" class="nav-link">netty</a></div><div class="nav-item"><a href="/md/DDD/小傅哥案例学习打卡/DDD抽奖系统学习打卡🚀 day 1.html" class="nav-link">DDD</a></div><div class="nav-item"><a href="/md/other/面试题.html" class="nav-link">other</a></div><div class="nav-item"><a href="/md/notes/" class="nav-link">测试</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="提示语" class="dropdown-title"><!----> <span class="title" style="display:;">测试下拉菜单</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/notes/" class="nav-link">菜单1</a></li><li class="dropdown-item"><!----> <a href="/md/notes/" class="nav-link">菜单2</a></li><li class="dropdown-item"><h4>多次菜单</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/notes/" class="nav-link">多级菜单1</a></li></ul></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JAVA</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/dc132d/" class="sidebar-link">JAVA基础</a></li><li><a href="/pages/d9f5d1/" class="sidebar-link">java8新特性</a></li><li><a href="/pages/b4de67/" class="sidebar-link">JVM</a></li><li><a href="/pages/4ef7a0/" class="sidebar-link">Spring</a></li><li><a href="/pages/4bcf6f/" class="sidebar-link">SpringBoot</a></li><li><a href="/pages/bf25fe/" class="sidebar-link">Gateway网关</a></li><li><a href="/pages/7a7d4b/" aria-current="page" class="active sidebar-link">并发常见</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/7a7d4b/#创建线程的四种方式" class="sidebar-link">创建线程的四种方式</a></li><li class="sidebar-sub-header level2"><a href="/pages/7a7d4b/#并发编程三要素" class="sidebar-link">并发编程三要素</a></li><li class="sidebar-sub-header level2"><a href="/pages/7a7d4b/#可见性和指令重排是怎么回事" class="sidebar-link">可见性和指令重排是怎么回事?</a></li><li class="sidebar-sub-header level2"><a href="/pages/7a7d4b/#volatile关键字" class="sidebar-link">volatile关键字</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#如何保证可见性" class="sidebar-link">如何保证可见性</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#如何防止指令重排" class="sidebar-link">如何防止指令重排</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#无法保证原子性" class="sidebar-link">无法保证原子性</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/7a7d4b/#synchronized" class="sidebar-link">synchronized</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#使用方法" class="sidebar-link">使用方法</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#底层原理" class="sidebar-link">底层原理</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#为什么添加-synchronized-也能保证变量的可见性呢" class="sidebar-link">为什么添加 synchronized 也能保证变量的可见性呢?</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/7a7d4b/#threadlocal" class="sidebar-link">ThreadLocal</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#不使用threadlocal-一个值会被多个线程一次修改" class="sidebar-link">不使用ThreadLocal, 一个值会被多个线程一次修改</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#如果使用threadlocal-那么每个线程便可以自己维护一份数据" class="sidebar-link">如果使用ThreadLocal, 那么每个线程便可以自己维护一份数据</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#底层原理-2" class="sidebar-link">底层原理</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#threadlocal内存泄露是怎么到导致的" class="sidebar-link">ThreadLocal内存泄露是怎么到导致的</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/7a7d4b/#线程池" class="sidebar-link">线程池</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#线程池的优势" class="sidebar-link">线程池的优势</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#线程池执行过程" class="sidebar-link">线程池执行过程</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#线程池的主要参数" class="sidebar-link">线程池的主要参数</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#拒绝策略" class="sidebar-link">拒绝策略</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#线程池的创建" class="sidebar-link">线程池的创建</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#线程池使用例子" class="sidebar-link">线程池使用例子</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#死锁怎么解决" class="sidebar-link">死锁怎么解决?</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/7a7d4b/#juc是啥" class="sidebar-link">JUC是啥</a></li><li class="sidebar-sub-header level2"><a href="/pages/7a7d4b/#cas是啥" class="sidebar-link">CAS是啥</a></li><li class="sidebar-sub-header level2"><a href="/pages/7a7d4b/#aba问题" class="sidebar-link">ABA问题</a></li><li class="sidebar-sub-header level2"><a href="/pages/7a7d4b/#如何解决aba问题" class="sidebar-link">如何解决ABA问题</a></li><li class="sidebar-sub-header level2"><a href="/pages/7a7d4b/#原子类" class="sidebar-link">原子类</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#juc-包中的原子类是哪-4-类" class="sidebar-link">JUC 包中的原子类是哪 4 类?</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/7a7d4b/#原子引用-atomicreference" class="sidebar-link">原子引用 AtomicReference</a></li><li class="sidebar-sub-header level2"><a href="/pages/7a7d4b/#集合类不安全的问题" class="sidebar-link">集合类不安全的问题</a></li><li class="sidebar-sub-header level2"><a href="/pages/7a7d4b/#常见并发容器" class="sidebar-link">常见并发容器</a></li><li class="sidebar-sub-header level2"><a href="/pages/7a7d4b/#锁" class="sidebar-link">锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#公平锁-非公平锁" class="sidebar-link">公平锁/非公平锁</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#可重入锁-又名递归锁" class="sidebar-link">可重入锁(又名递归锁)</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#synchronized可重入的原理" class="sidebar-link">synchronized可重入的原理</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#reentrantlock可重入的原理" class="sidebar-link">ReentrantLock可重入的原理</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#自旋锁" class="sidebar-link">自旋锁</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#独占锁-写锁-共享锁-读锁-互斥锁" class="sidebar-link">独占锁(写锁)/共享锁(读锁)/互斥锁</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#countdownlatch-cyclicbarrier-semaphore" class="sidebar-link">CountDownLatch/CyclicBarrier/Semaphore</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#阻塞队列" class="sidebar-link">阻塞队列</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#生产消费模式" class="sidebar-link">生产消费模式</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#synchronized和lock有什么区别" class="sidebar-link">synchronized和lock有什么区别</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#reentrantlock怎么精确唤醒线程-比如a→b→c依次唤醒线程" class="sidebar-link">ReentrantLock怎么精确唤醒线程,比如A→B→C依次唤醒线程</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#locksupport" class="sidebar-link">LockSupport</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#三种让线程等待的方法" class="sidebar-link">三种让线程等待的方法</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/7a7d4b/#aqs" class="sidebar-link">AQS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/7a7d4b/#aqs源码" class="sidebar-link">AQS源码</a></li></ul></li></ul></li><li><a href="/pages/fd10b9/" class="sidebar-link">分布式事务</a></li><li><a href="/pages/74109b/" class="sidebar-link">springboot整合多数据源</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>数据结构和算法</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>md</span></li><li data-v-06225672><span data-v-06225672>java</span></li></ul> <div class="info" data-v-06225672><!----> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-10-27</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">并发常见<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="并发常见"><a href="#并发常见" class="header-anchor">#</a> 并发常见</h1> <h2 id="创建线程的四种方式"><a href="#创建线程的四种方式" class="header-anchor">#</a> 创建线程的四种方式</h2> <ol><li><p>继承Thread;</p></li> <li><p>实现runnable接口</p></li> <li><p>实现callable接口, 结合FutureTask使用</p> <p>Thread实例需要传入runnable实现类,需要利用futureTask将callable转为runnable</p> <p>FutureTask task = new FutureTask(myThread );
new Thread(task).start();</p></li> <li><p>利用线程池使用</p></li></ol> <h2 id="并发编程三要素"><a href="#并发编程三要素" class="header-anchor">#</a> 并发编程三要素</h2> <p>原子性、可见性、有序性</p> <p>保证原子性的操作: Atomic包, CAS算法, synchronized, Lock</p> <p>保证可见性的操作: synchronized, volatile</p> <p>保证有序性的操作: hanppens-before原则</p> <p><img src="/assets/img/1.f3e467c8.png" alt=""></p> <h2 id="可见性和指令重排是怎么回事"><a href="#可见性和指令重排是怎么回事" class="header-anchor">#</a> 可见性和指令重排是怎么回事?</h2> <ul><li>可见性, java编程语言允许线程访问共享变量, 为了确保共享变量能被准确和一致性的更新, 线程应该确保通过排它锁单独获取这个变量</li> <li>指令重排, 在程序执行过程中为了性能考虑, 编译器和cpu可能会对指令重新排序, 对于并发多线程场景下, 指令重排会产生不确定的执行效果</li></ul> <h2 id="volatile关键字"><a href="#volatile关键字" class="header-anchor">#</a> volatile关键字</h2> <p>可见性, 防止指令重排, 不能保证原子性</p> <h3 id="如何保证可见性"><a href="#如何保证可见性" class="header-anchor">#</a> 如何保证可见性</h3> <p>在 Java 中，<code>volatile</code> 关键字可以保证变量的可见性，如果我们将变量声明为 <strong><code>volatile</code></strong> ，这就指示 JVM，这个变量是共享且不稳定的，每次使用它都到主存中进行读取。</p> <ul><li>首先, volatile关键字修饰的共享变量可以提供这种可见性规范, 也叫作读写可见</li> <li>被valatile关键字修饰的共享变量在转换为汇编语言时, 会加上一个以lock为前缀的指令, 当cpu发现这个指令时, 立即将当前内核高速缓存行的数据会写到内存, 同时使其他内核里缓存了该内存地址的数据无效</li> <li>另外, 在早期的cpu中, 是通过在总线LOCK#锁的方式实现的, 但这种方式开销较大. 所以intel开发了缓存一致性协议, 也就是MESI协议, 解决了缓存一致性</li> <li>volatile的好处, volatile是一种非锁机制, 这种机制可以避免锁机制引起的线程上下文切换和调度问题. 所以, volatile的执行成本比synchronized更低</li> <li>volatile的不足, volatile关键字只能保证可见性, 不能保证原子性操作</li> <li>此外Unsafe.loadFence(); 保证在这个屏障之前的所有读操作都已经完成。的一些使用，那么面试绝对可以加分。  这是个啥?</li></ul> <h3 id="如何防止指令重排"><a href="#如何防止指令重排" class="header-anchor">#</a> 如何防止指令重排</h3> <p>如果将一个变量声明为volatile, 在对这个变量进行读写操作时, 会通过插入<strong>内存屏障</strong>的方式来禁止指令重排序</p> <p>在java中,<code>unsafe</code>类提供了三个内存屏障相关的本地方法, 屏蔽了操作系统底层的差异</p> <p>在<strong>双重校验锁</strong>实现单例模式的例子中看</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> uniqueInstance<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span>  <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getUniqueInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//先判断对象是否已经实例过，没有实例化过才进入加锁代码</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>uniqueInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//类对象加锁</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>uniqueInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    uniqueInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> uniqueInstance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>uniqueInstance</code> 采用 <code>volatile</code> 关键字修饰也是很有必要的， <code>uniqueInstance = new Singleton();</code> 这段代码其实是分为三步执行：</p> <ol><li>为 <code>uniqueInstance</code> 分配内存空间</li> <li>初始化 <code>uniqueInstance</code></li> <li>将 <code>uniqueInstance</code> 指向分配的内存地址</li></ol> <p>但是由于 JVM 具有指令重排的特性，执行顺序有可能变成 1-&gt;3-&gt;2。指令重排在单线程环境下不会出现问题，但是在多线程环境下会导致一个线程获得还没有初始化的实例。例如，线程 T1 执行了 1 和 3，此时 T2 调用 <code>getUniqueInstance</code>() 后发现 <code>uniqueInstance</code> 不为空，因此返回 <code>uniqueInstance</code>，但此时 <code>uniqueInstance</code> 还未被初始化。</p> <h3 id="无法保证原子性"><a href="#无法保证原子性" class="header-anchor">#</a> 无法保证原子性</h3> <h2 id="synchronized"><a href="#synchronized" class="header-anchor">#</a> synchronized</h2> <p><code>synchronized</code> 翻译成中文是同步的的意思，主要解决的是多个线程之间访问资源的同步性，可以保证被它修饰的方法或者代码块在任意时刻只能有一个线程执行。</p> <p>在 Java 早期版本中，<code>synchronized</code> 属于 <strong>重量级锁</strong>，效率低下。 因为监视器锁（monitor）是依赖于底层的操作系统的 <code>Mutex Lock</code> 来实现的，Java 的线程是映射到操作系统的原生线程之上的。如果要挂起或者唤醒一个线程，都需要操作系统帮忙完成，而操作系统实现线程之间的切换时需要从用户态转换到内核态，这个状态之间的转换需要相对比较长的时间，时间成本相对较高。</p> <p>不过，在 Java 6 之后，Java 官方对从 JVM 层面对 <code>synchronized</code> 较大优化，所以现在的 <code>synchronized</code> 锁效率也优化得很不错了。JDK1.6 对锁的实现引入了大量的优化，如自旋锁、适应性自旋锁、锁消除、锁粗化、偏向锁、轻量级锁等技术来减少锁操作的开销。所以，你会发现目前的话，不论是各种开源框架还是 JDK 源码都大量使用了 <code>synchronized</code> 关键字。</p> <h3 id="使用方法"><a href="#使用方法" class="header-anchor">#</a> 使用方法</h3> <p>synchronized 关键字最主要的三种使用方式：</p> <ol><li>修饰实例方法   锁当前对象实例</li> <li>修饰静态方法   锁当前类</li> <li>修饰代码块   所指定对象/类</li></ol> <h3 id="底层原理"><a href="#底层原理" class="header-anchor">#</a> 底层原理</h3> <p>synchronized 是属于JVM层面</p> <p>当我们使用javap查看类的字节码文件时,可以看到, <strong>在同步代码块使用了<code>monitorenter</code> 和 <code>monitorexit</code> 指令，其中 <code>monitorenter</code> 指令指向同步代码块的开始位置，<code>monitorexit</code> 指令则指明同步代码块的结束位置。</strong></p> <p><img src="data:image/png;base64,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" alt="image-20221104100920195"></p> <p>当执行 <code>monitorenter</code> 指令时，线程试图获取锁也就是获取 <strong>对象监视器 <code>monitor</code></strong> 的持有权。</p> <blockquote><p>在 Java 虚拟机(HotSpot)中，Monitor 是基于 C++实现的，由<a href="https://github.com/openjdk-mirror/jdk7u-hotspot/blob/50bdefc3afe944ca74c3093e7448d6b889cd20d1/src/share/vm/runtime/objectMonitor.cpp" target="_blank" rel="noopener noreferrer">ObjectMonitoropen in new window<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>实现的。每个对象中都内置了一个 <code>ObjectMonitor</code>对象。</p> <p>另外，<code>wait/notify</code>等方法也依赖于<code>monitor</code>对象，这就是为什么只有在同步的块或者方法中才能调用<code>wait/notify</code>等方法，否则会抛出<code>java.lang.IllegalMonitorStateException</code>的异常的原因。</p></blockquote> <p>如果用synchronized 修饰方法:<strong>并没有 <code>monitorenter</code> 指令和 <code>monitorexit</code> 指令，取得代之的确实是 <code>ACC_SYNCHRONIZED</code> 标识，该标识指明了该方法是一个同步方法。JVM 通过该 <code>ACC_SYNCHRONIZED</code> 访问标志来辨别一个方法是否声明为同步方法，从而执行相应的同步调用。</strong></p> <p><img src="/assets/img/image-20221104100940188.460cb803.png" alt="image-20221104100940188"></p> <h3 id="为什么添加-synchronized-也能保证变量的可见性呢"><a href="#为什么添加-synchronized-也能保证变量的可见性呢" class="header-anchor">#</a> 为什么添加 synchronized 也能保证变量的可见性呢?</h3> <ol><li>线程解锁前, 必须把共享变量的最新值刷新到主内存中</li> <li>线程加锁前, 将清空工作内存中共享变量的值, 从而使用共享变量时需要从主内存中重新读取最新的值</li> <li>volatile的可见性都是通过内存屏障来实现的</li> <li>synchronized靠操作系统内核互斥锁实现, 相当于JMM中的lock 、unlock. 退出代码块时刷新变量到主内存</li></ol> <h2 id="threadlocal"><a href="#threadlocal" class="header-anchor">#</a> ThreadLocal</h2> <p>通常我们创建的变量时可以被所有线程共享的, 如果想实现一个线程有一份自己专属的本地变量, 就需要用到ThreadLocal</p> <p><strong><code>ThreadLocal</code>类主要解决的就是让每个线程绑定自己的值，可以将<code>ThreadLocal</code>类形象的比喻成存放数据的盒子，盒子中可以存储每个线程的私有数据。</strong></p> <p>如果你创建了一个<code>ThreadLocal</code>变量，那么访问这个变量的每个线程都会有这个变量的本地副本，这也是<code>ThreadLocal</code>变量名的由来。他们可以使用 <code>get()</code> 和 <code>set()</code> 方法来获取默认值或将其值更改为当前线程所存的副本的值，从而避免了线程安全问题。</p> <h3 id="不使用threadlocal-一个值会被多个线程一次修改"><a href="#不使用threadlocal-一个值会被多个线程一次修改" class="header-anchor">#</a> 不使用ThreadLocal, 一个值会被多个线程一次修改</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//遍历创建三个线程,来修改一个值</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">ThreadLocalDemo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;拿到数据:&quot;</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    num<span class="token operator">--</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;修改数据:&quot;</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;线程&quot;</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

输出<span class="token operator">:</span>
线程<span class="token number">0</span>拿到数据<span class="token operator">:</span><span class="token number">10</span>
线程<span class="token number">0</span>修改数据<span class="token operator">:</span><span class="token number">9</span>
线程<span class="token number">2</span>拿到数据<span class="token operator">:</span><span class="token number">9</span>
线程<span class="token number">2</span>修改数据<span class="token operator">:</span><span class="token number">8</span>
线程<span class="token number">1</span>拿到数据<span class="token operator">:</span><span class="token number">8</span>
线程<span class="token number">1</span>修改数据<span class="token operator">:</span><span class="token number">7</span>
</code></pre></div><h3 id="如果使用threadlocal-那么每个线程便可以自己维护一份数据"><a href="#如果使用threadlocal-那么每个线程便可以自己维护一份数据" class="header-anchor">#</a> 如果使用ThreadLocal, 那么每个线程便可以自己维护一份数据</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> num <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//遍历创建三个线程,来修改一个值</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">ThreadLocalDemo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;拿到数据:&quot;</span> <span class="token operator">+</span> num<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    num<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>num<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;修改数据:&quot;</span> <span class="token operator">+</span> num<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;线程&quot;</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

输出<span class="token operator">:</span>
线程<span class="token number">0</span>拿到数据<span class="token operator">:</span><span class="token number">10</span>
线程<span class="token number">0</span>修改数据<span class="token operator">:</span><span class="token number">9</span>
线程<span class="token number">2</span>拿到数据<span class="token operator">:</span><span class="token number">10</span>
线程<span class="token number">2</span>修改数据<span class="token operator">:</span><span class="token number">9</span>
线程<span class="token number">1</span>拿到数据<span class="token operator">:</span><span class="token number">10</span>
线程<span class="token number">1</span>修改数据<span class="token operator">:</span><span class="token number">9</span>
</code></pre></div><h3 id="底层原理-2"><a href="#底层原理-2" class="header-anchor">#</a> 底层原理</h3> <p>我们从get()方法进入可以发现, 里面获取的当前线程, 然后将当前线程中的<strong>ThreadLocalMap</strong>取了出来,然后从中取出当前对象</p> <p><strong>每个<code>Thread</code>中都具备一个<code>ThreadLocalMap</code>，而<code>ThreadLocalMap</code>可以存储以<code>ThreadLocal</code>为 key ，Object 对象为 value 的键值对。</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取当前请求线程</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获取当前线程中的 threadLocals</span>
    <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//不为空, 则从中取出当前对象</span>
        <span class="token class-name">ThreadLocalMap<span class="token punctuation">.</span>Entry</span> e <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
            <span class="token class-name">T</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//线程的threadLocals默认是null, 当调用get或set时才创建</span>
    <span class="token keyword">return</span> <span class="token function">setInitialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="threadlocal内存泄露是怎么到导致的"><a href="#threadlocal内存泄露是怎么到导致的" class="header-anchor">#</a> ThreadLocal内存泄露是怎么到导致的</h3> <p><code>ThreadLocalMap</code> 中使用的 key 为 <code>ThreadLocal</code> 的弱引用，而 value 是强引用。所以，如果 <code>ThreadLocal</code> 没有被外部强引用的情况下，在垃圾回收的时候，key 会被清理掉，而 value 不会被清理掉。</p> <p>这样一来，<code>ThreadLocalMap</code> 中就会出现 key 为 null 的 Entry。假如我们不做任何措施的话，value 永远无法被 GC 回收，这个时候就可能会产生内存泄露。<code>ThreadLocalMap</code> 实现中已经考虑了这种情况，在调用 <code>set()</code>、<code>get()</code>、<code>remove()</code> 方法的时候，会清理掉 key 为 null 的记录。使用完 <code>ThreadLocal</code>方法后 最好手动调用<code>remove()</code>方法</p> <h2 id="线程池"><a href="#线程池" class="header-anchor">#</a> 线程池</h2> <h3 id="线程池的优势"><a href="#线程池的优势" class="header-anchor">#</a> 线程池的优势</h3> <p>1.降低系统资源消耗, 通过重用已存在的线程, 降低线程创建和销毁造成的消耗;</p> <p>2.提高系统的响应速度, 当有任务到达时, 通过复用已存在的线程, 无需等待新线程的创建便能立即执行;</p> <p>3.方便线程并发数的管控, 因为线程若是无限制的创建, 可能会导致内存占用过多而用尽内存, 并且会造成cpu过度切换</p> <p>4.提供更强大的功能, 延时定时线程池.</p> <h3 id="线程池执行过程"><a href="#线程池执行过程" class="header-anchor">#</a> 线程池执行过程</h3> <p>1.新的线程请求进来后, 先判断核心线程数量是否已满, 如果没有则直接新建线程执行,执行完将其放回线程池</p> <p>2.如果核心线程已满就检查队列是否已满, 如果没满就将当前线程请求加入阻塞队列, 等待空闲线程分配</p> <p>3.如果队列已满, 就再检查线程池存在线程是否达到最大值, 如果没有就创建非核心线程执行</p> <p>4.如果线程数到达了最大, 那么执行对应的拒绝策略.</p> <p><strong>为什么是先放入队列,在创建非核心线程呢? 非核心线程怎么处理?</strong></p> <ul><li>线程池创建线程需要获取 mainlock 这个全局锁，会影响并发效率，所以使用阻塞队列把第一步创建核心线程与第三步创建最大线程隔离开来，起一个缓冲的作用。</li> <li>引入阻塞队列，是为了在执行 execute() 方法时，尽可能的避免获取全局锁。</li> <li>当任务数量少时, 会将空闲的线程销毁, 保留核心线程</li></ul> <h3 id="线程池的主要参数"><a href="#线程池的主要参数" class="header-anchor">#</a> 线程池的主要参数</h3> <p>使用 ThreadPoolExecutor</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>    <span class="token comment">//核心线程数量</span>
                          <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>   <span class="token comment">//最大线程数量</span>
                          <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>   <span class="token comment">//非核心空闲线程存活时长</span>
                          <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span>   <span class="token comment">//时间单位</span>
                          <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">,</span>   <span class="token comment">//任务队列</span>
                          <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span>   <span class="token comment">//线程工厂(可以不传用默认的) </span>
                          <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//拒绝策略(当任务队列满了且也达到了线程最大数量时的处理方案)</span>
</code></pre></div><p>1.corePoolSize (核心线程数量)</p> <p>2.maximumPoolSize (最大线程数量)</p> <p>3.keepAliveTime (线程存活时间): 非核心线程的存活时间</p> <p>4.unit:keepAliveTime的单位</p> <p>5.workQueue (任务队列): 用于传输和保存等待执行任务的阻塞队列</p> <p>6.ThreadFactory (线程工厂)</p> <p>​	比如: new ThreadFactoryBuilder().setNameFormat(&quot;线程&quot;+&quot;-%d&quot;).setDaemon(true).build(),  //线程工厂(选填), setNameFormat指定线程名规则</p> <p>7.Handler (拒绝策略): 当线程池和队列都满了, 在加入线程时会执行此策略</p> <p><img src="/assets/img/image-6dd0024d89514e10a96c1e2bcb2df79e.398058f0.png" alt="../../img/other/image-6dd0024d89514e10a96c1e2bcb2df79e.png"></p> <h3 id="拒绝策略"><a href="#拒绝策略" class="header-anchor">#</a> 拒绝策略</h3> <p><code>AbortPolicy</code>(默认) : 直接抛出异常阻止系统正常运行</p> <p><code>CallerRunsPolicy</code> : &quot;调用者运行”一种调节机制, 该策略既不会抛弃任务, 也不会抛异常, 而是将有些任务回退到调用者</p> <p><code>DiscardOldestPolicy</code> : 抛弃队列中等待最久的任务, 然后将当前任务加入队列中尝试再次提交当前任务</p> <p><code>DiscardPolicy</code> : 直接抛弃任务, 不予任何处理也不抛异常.  如果我们的业务允许丢失任务,那是最好的方案</p> <h3 id="线程池的创建"><a href="#线程池的创建" class="header-anchor">#</a> 线程池的创建</h3> <h4 id="springboot-async异步任务"><a href="#springboot-async异步任务" class="header-anchor">#</a> SpringBoot @Async异步任务</h4> <p>如果没有配置线程池, 使用@Async注解, 默认会使用一个最大线程数为20的线程池</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Asyncpublic</span> 
<span class="token keyword">class</span> <span class="token class-name">AsyncTask</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">task4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
      <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;任务4耗时=&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span>end<span class="token operator">-</span>begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AsyncResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;任务4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">task5</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
      <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;任务5耗时=&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span>end<span class="token operator">-</span>begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AsyncResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;任务5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">task6</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
      <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;任务6耗时=&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span>end<span class="token operator">-</span>begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AsyncResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;任务6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>2.使用</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/AsyTask&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestAsyTask</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AsyncTask</span> task<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/Task&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">exeTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
        <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> task4 <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">task4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> task5 <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">task5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> task6 <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">task6</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
        <span class="token class-name">String</span> s1 <span class="token operator">=</span> task4 <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> s2 <span class="token operator">=</span> task5 <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> s3 <span class="token operator">=</span> task6 <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> total <span class="token operator">=</span> end<span class="token operator">-</span>begin<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行总耗时=&quot;</span><span class="token operator">+</span>total<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>3.启动类</p> <div class="language- extra-class"><pre class="language-text"><code>@EnableAsync
</code></pre></div><h4 id="使用spring的线程池"><a href="#使用spring的线程池" class="header-anchor">#</a> 使用spring的线程池</h4> <p>spring的线程池就是封装的java的ThreadPoolExecutor</p> <p>1.注入spring</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;springexecutors&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">springexecutors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">ThreadPoolTaskExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//核心线程数</span>
        executor<span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//最大线程数</span>
        executor<span class="token punctuation">.</span><span class="token function">setMaxPoolSize</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//线程保持时间 秒</span>
        executor<span class="token punctuation">.</span><span class="token function">setKeepAliveSeconds</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//队列的存储个数</span>
        executor<span class="token punctuation">.</span><span class="token function">setQueueCapacity</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//拒绝策略</span>
        executor<span class="token punctuation">.</span><span class="token function">setRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> executor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>2.引用</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;springexecutors&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Executor</span> springexecutors<span class="token punctuation">;</span>
</code></pre></div><p>3.使用</p> <div class="language-java extra-class"><pre class="language-java"><code>springexecutors<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getData2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> springexecutors<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Callable+&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;成功！&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
</code></pre></div><p>4.注解使用</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Async</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;springexecutors&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncTask</span> <span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
     <span class="token keyword">try</span> <span class="token punctuation">{</span>
           <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i <span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><h4 id="使用java的线程池"><a href="#使用java的线程池" class="header-anchor">#</a> 使用java的线程池</h4> <p>1.注入spring</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;javaexecutor&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">javaexecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">ThreadPoolExecutor</span> javaexecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
                <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">//核心线程数</span>
                <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">//最大线程数</span>
                <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">//线程保持时间</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span> <span class="token comment">//线程保持时间单位</span>
                <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//线程缓存队列</span>
                <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//拒绝策略</span>
        <span class="token keyword">return</span> javaexecutor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>2.引用</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;javaexecutor&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Executor</span> javaexecutor<span class="token punctuation">;</span>
</code></pre></div><p>3.使用</p> <div class="language-java extra-class"><pre class="language-java"><code>javaexecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>或</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Async</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;javaexecutor&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncTask</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
     <span class="token keyword">try</span> <span class="token punctuation">{</span>
           <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i <span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><h4 id="通过executor框架爱的工具类executors来实现"><a href="#通过executor框架爱的工具类executors来实现" class="header-anchor">#</a> 通过Executor框架爱的工具类Executors来实现</h4> <p><img src="/assets/img/image-20221104140116307.23c71c54.png" alt="image-20221104140116307"></p> <p>1.CachedThreadPool:可缓存的线程池，该线程池中没有核心线程，非核心线程的数量为Integer.max_value，就是无限大，当有需要时创建线程来执行任务，没有需要时回收线程，适用于耗时少，任务量大的情况。</p> <p>2.SecudleThreadPool:周期性执行任务的线程池，按照某种特定的计划执行线程中的任务，有核心线程，但也有非核心线程，非核心线程的大小也为无限大。适用于执行周期性的任务。</p> <p>3.SingleThreadPool:只有一条线程来执行任务，适用于有顺序的任务的应用场景。</p> <p>4.FixedThreadPool:定长的线程池，有核心线程，核心线程的即为最大的线程数量，没有非核心线程</p> <h4 id="executors提供的线程为啥不推荐使用"><a href="#executors提供的线程为啥不推荐使用" class="header-anchor">#</a> Executors提供的线程为啥不推荐使用?</h4> <p>因为在并发中提供的哪几种方法会造成OOM, 有的是因为使用的任务队列类型(链表有界阻塞队列)会造成OOM; 有的是因为没有限制线程数量,造成OOM</p> <h4 id="线程池合理配置"><a href="#线程池合理配置" class="header-anchor">#</a> 线程池合理配置</h4> <p>线程池的最佳大小取决于可用的处理器数量和待处理任务的性质。</p> <p>对于 CPU 密集型任务，假设系统有 N 个逻辑处理核心，N 或 N+1 的最大线程池数量大小将实现最大效率。</p> <p>对于 I/O 密集型任务，大部分线程会阻塞,所以需要多配置线程, cpu核数/1-阻塞系数  阻塞系数在0.8-0.9</p> <p>需要考虑请求的等待时间（W）和服务处理时间（S）的比例，线程池最大大小为 N*(1+ W/S) 会实现最高效率。</p> <h3 id="线程池使用例子"><a href="#线程池使用例子" class="header-anchor">#</a> 线程池使用例子</h3> <h4 id="创建线程"><a href="#创建线程" class="header-anchor">#</a> 创建线程</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//需要多线程执行的任务</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadDemo</span> <span class="token keyword">implements</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">//伪装 线程中需要的传入参数</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> data<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ThreadDemo</span><span class="token punctuation">(</span><span class="token class-name">String</span> data<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;执行任务:&quot;</span><span class="token operator">+</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;结果:&quot;</span><span class="token operator">+</span>data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="线程池-2"><a href="#线程池-2" class="header-anchor">#</a> 线程池</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//获取线程池</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolDemo</span> <span class="token punctuation">{</span>
    <span class="token comment">//创建线程池  这里设置成了静态的  也可以提供get方法</span>
    <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> threadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
            <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">//核心线程数  2</span>
            <span class="token number">10</span><span class="token punctuation">,</span>  <span class="token comment">//最大线程数  5</span>
            <span class="token number">1L</span><span class="token punctuation">,</span>  <span class="token comment">//等待时间  1L</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span>   <span class="token comment">//等待时间单位</span>
            <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">//任务队列  容量为5</span>
            <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;线程&quot;</span><span class="token operator">+</span><span class="token string">&quot;-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//线程工厂(选填), setNameFormat指定线程名规则</span>
            <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">//拒绝策略</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="模拟使用"><a href="#模拟使用" class="header-anchor">#</a> 模拟使用</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Start</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//结果集合</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Future</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> futureList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//通过线程池执行线程</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ThreadDemo</span> threadDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadDemo</span><span class="token punctuation">(</span><span class="token string">&quot;我是第&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;个参数&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> submit <span class="token operator">=</span> <span class="token class-name">ThreadPoolDemo</span><span class="token punctuation">.</span>threadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>threadDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            futureList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>submit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果在上面循环中get会阻塞等待响应  Future是响应的载体但是响应数据不一定放进去了, 如果我们从中get便会阻塞获取</span>
        <span class="token comment">//所以在输出结果中可以看到,线程的执行先后顺序是无序的,但是结果的打印是有序的, 那是因为我们将Future放入list是有序的,遍历</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stringFuture <span class="token operator">:</span> futureList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stringFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> <span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//测试方法执行完  需要关掉线程池不能会一直运行</span>
        <span class="token comment">//ThreadPoolDemo.threadPool.shutdown();</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="死锁怎么解决"><a href="#死锁怎么解决" class="header-anchor">#</a> 死锁怎么解决?</h3> <p>jps命令定位进程号</p> <p>jstack找到死锁查看</p> <h2 id="juc是啥"><a href="#juc是啥" class="header-anchor">#</a> JUC是啥</h2> <p>java.utli.concurrent包和它下面的atomic(原子), locks包</p> <h2 id="cas是啥"><a href="#cas是啥" class="header-anchor">#</a> CAS是啥</h2> <p>check and Swap   检查并交换</p> <p>相当于乐观锁, JUC的atomic就是通过调用sun.misc.unsafe的各种cas并发原语体方法</p> <p>缺点: 自旋时间过长cpu开销较大; 只能保证一个共享变量的原子操作; ABA问题</p> <p>一般问题牵扯流程: CAS—&gt;Unsafe—&gt;CAS底层思想—&gt;ABA—&gt;原子引用更新—&gt;如何规避ABA问题</p> <h2 id="aba问题"><a href="#aba问题" class="header-anchor">#</a> ABA问题</h2> <p>因为CAS比对的当前值和期望值是否相等, 但是如果这个数据被其他线程由A变成了B, 然后又从B改成了A, 这时比对会发现是相等的, 但是两个A并不是同一个了</p> <p>这种情况在数据库中乐观锁是加version标识判断版本</p> <h2 id="如何解决aba问题"><a href="#如何解决aba问题" class="header-anchor">#</a> 如何解决ABA问题</h2> <p>和乐观锁加version一样</p> <p>理解原子引用 + 新增机制，修改版本号(类似时间戳)</p> <p><code>AtomicStampedReference</code> 添加了版本号，修改时需要判断对象地址+版本号</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">AtomicStampedReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> objectAtomicStampedReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicStampedReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
objectAtomicStampedReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="原子类"><a href="#原子类" class="header-anchor">#</a> 原子类</h2> <p><code>Atomic</code> 翻译成中文是原子的意思。在化学上，我们知道原子是构成一般物质的最小单位，在化学反应中是不可分割的。在我们这里 Atomic 是指一个操作是不可中断的。即使是在多个线程一起执行的时候，一个操作一旦开始，就不会被其他线程干扰。</p> <p>所以，所谓原子类说简单点就是具有原子/原子操作特征的类。</p> <p>并发包 <code>java.util.concurrent</code> 的原子类都存放在<code>java.util.concurrent.atomic</code></p> <h3 id="juc-包中的原子类是哪-4-类"><a href="#juc-包中的原子类是哪-4-类" class="header-anchor">#</a> JUC 包中的原子类是哪 4 类?</h3> <p><strong>基本类型</strong></p> <p>使用原子的方式更新基本类型</p> <ul><li><code>AtomicInteger</code>：整型原子类</li> <li><code>AtomicLong</code>：长整型原子类</li> <li><code>AtomicBoolean</code>：布尔型原子类</li></ul> <p><strong>数组类型</strong></p> <p>使用原子的方式更新数组里的某个元素</p> <ul><li><code>AtomicIntegerArray</code>：整型数组原子类</li> <li><code>AtomicLongArray</code>：长整型数组原子类</li> <li><code>AtomicReferenceArray</code>：引用类型数组原子类</li></ul> <p><strong>引用类型</strong></p> <ul><li><code>AtomicReference</code>：引用类型原子类</li> <li><code>AtomicStampedReference</code>：原子更新带有版本号的引用类型。该类将整数值与引用关联起来，可用于解决原子的更新数据和数据的版本号，可以解决使用 CAS 进行原子更新时可能出现的 ABA 问题。</li> <li><code>AtomicMarkableReference</code> ：原子更新带有标记位的引用类型</li></ul> <p><strong>对象的属性修改类型</strong></p> <ul><li><code>AtomicIntegerFieldUpdater</code>：原子更新整型字段的更新器</li> <li><code>AtomicLongFieldUpdater</code>：原子更新长整型字段的更新器</li> <li><code>AtomicReferenceFieldUpdater</code>：原子更新引用类型字段的更新器</li></ul> <h2 id="原子引用-atomicreference"><a href="#原子引用-atomicreference" class="header-anchor">#</a> 原子引用 <code>AtomicReference</code></h2> <p>对 ”对象” 进行原子操作</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">User</span> user1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span> <span class="token punctuation">(</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;24&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">User</span> user2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span> <span class="token punctuation">(</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;47&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userAtomicReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
userAtomicReference<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>
userAtomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>user1<span class="token punctuation">,</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这是比较的是对象地址, 如果地址不变认为是相同的</p> <h2 id="集合类不安全的问题"><a href="#集合类不安全的问题" class="header-anchor">#</a> 集合类不安全的问题</h2> <p>多线程操作arrayList集合的时候，是没有锁的    vector是安全的,它的add和get都加了synchronized,并发性不高</p> <ol><li><p>故障现象
java.util.ConcurrentModdificationException   并发修改异常</p></li> <li><p>导致原因</p></li> <li><p>解决方案</p> <ol><li><p>如果不考虑并发可以用vector;</p></li> <li><p>使用Collections.synchronizedList将普通的list转为线程安全的</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>使用JUC下的CopyOnWriteArrayList类
底层数组被volatile修饰, 保证了可见性
add方法中使用代码块锁, 并且是先复制在修改然后写入, 读写分离不会在写过程影响读</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//jdk11</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> es <span class="token operator">=</span> <span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> es<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        es <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>es<span class="token punctuation">,</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        es<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
        <span class="token function">setArray</span><span class="token punctuation">(</span>es<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol></li> <li><p>优化建议</p></li></ol> <h2 id="常见并发容器"><a href="#常见并发容器" class="header-anchor">#</a> 常见并发容器</h2> <p>JDK 提供的这些容器大部分在 <code>java.util.concurrent</code> 包中。</p> <ul><li><strong><code>ConcurrentHashMap</code></strong> : 线程安全的 <code>HashMap</code></li> <li><strong><code>CopyOnWriteArrayList</code></strong> : 线程安全的 <code>List</code>，在读多写少的场合性能非常好，远远好于 <code>Vector</code>。</li> <li><strong><code>ConcurrentLinkedQueue</code></strong> : 高效的并发队列，使用链表实现。可以看做一个线程安全的 <code>LinkedList</code>，这是一个非阻塞队列。</li> <li><strong><code>BlockingQueue</code></strong> : 这是一个接口，JDK 内部通过链表、数组等方式实现了这个接口。表示阻塞队列，非常适合用于作为数据共享的通道。</li> <li><strong><code>ConcurrentSkipListMap</code></strong> : 跳表的实现。这是一个 Map，使用跳表的数据结构进行快速查找。</li></ul> <h2 id="锁"><a href="#锁" class="header-anchor">#</a> 锁</h2> <h3 id="公平锁-非公平锁"><a href="#公平锁-非公平锁" class="header-anchor">#</a> 公平锁/非公平锁</h3> <p>公平锁: 是指多个线程按照申请锁的顺序来获取锁, 先来先得</p> <p>非公平锁: 是指多个线程获取锁的顺序不是按照申请的顺序;  可能造成优先级反转(后来的先获取锁)和饥饿现象(先来的一直没有获取到锁)   新线程直接尝试获取锁,没获取到采用类似公平锁的方式</p> <p>非公平锁吞吐量比公平锁高</p> <p>ReentrantLock初始化是默认非公平</p> <p>synchronized也是非公平锁</p> <h3 id="可重入锁-又名递归锁"><a href="#可重入锁-又名递归锁" class="header-anchor">#</a> 可重入锁(又名递归锁)</h3> <p>同一线程外层函数获得锁之后, 内层递归函数仍然能获取该锁的代码,
在同一线程在外层方法获取锁的时候, 在进入内层方法会自动获取锁</p> <p>synchronized 是线程锁住了对象。 synchronized 加在 非静态方法上，锁住的是 <strong>当前对象</strong>
。如果外层和内层加的是同一个锁对象</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> phone <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">sendsms</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;发送短信&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sendemail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">sendemail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;发送邮件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> test <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        phone phone <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">phone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            phone<span class="token punctuation">.</span><span class="token function">sendemail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            phone<span class="token punctuation">.</span><span class="token function">sendsms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>控制台输出<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
t1发送邮件
t2发送短信
t2发送邮件
</code></pre></div><p>也就是说, 同一线程可以进入它任何已经拥有的锁的所同步的代码块</p> <p>ReentrantLock/synchronized就是典型的可重入锁</p> <p>可重入锁可以避免死锁</p> <h3 id="synchronized可重入的原理"><a href="#synchronized可重入的原理" class="header-anchor">#</a> synchronized可重入的原理</h3> <p>每个锁对象拥有一个锁计数器和一个指向持有该锁的线程的指针</p> <p>当执行monitorenter时, 如果目标锁对象的计数器为零, 那么说明它没有被其他线程持有, java虚拟机会将该锁对象的持有线程设置为当前线程, 并且将其计数器加1</p> <p>在目标锁对象的计数器不为零的情况下, 如果锁对象的持有线程是当前线程, 那么java虚拟机可以将其计数器加1 , 否则需要等待, 直至持有线程释放该锁.</p> <p>当执行monitorexit时, java虚拟机则需要将锁对象的计数器减1, 计数器为零代表锁已被释放</p> <h3 id="reentrantlock可重入的原理"><a href="#reentrantlock可重入的原理" class="header-anchor">#</a> ReentrantLock可重入的原理</h3> <p>和synchronized类似也是有计数机制, 不过是从</p> <p><img src="/assets/img/2.8c61f312.png" alt=""></p> <h3 id="自旋锁"><a href="#自旋锁" class="header-anchor">#</a> 自旋锁</h3> <p>是指尝试获取锁的线程不会立即阻塞, 而是采用循环的方式尝试获取锁, 这样可以减少线程上下文切换的消耗, 缺点是循环会消耗cpu</p> <p>手写自旋锁</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
    <span class="token comment">//原子引用线程</span>
    <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> atomicReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">myLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取当前线程</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断atomicReference是null则把当前线程存入, 表示这个线程获取了锁</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>thread<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;尝试获取锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>thread<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;获取到了锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">myUnLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断是当前线程则存入null, 表示释放锁</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>thread<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;释放了锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Demo</span> demo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token comment">//获取demo实例的锁</span>
            demo<span class="token punctuation">.</span><span class="token function">myLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000l</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//释放锁</span>
            demo<span class="token punctuation">.</span><span class="token function">myUnLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token comment">//获取demo实例的锁</span>
            demo<span class="token punctuation">.</span><span class="token function">myLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//释放锁</span>
            demo<span class="token punctuation">.</span><span class="token function">myUnLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>控制台输出<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
t1尝试获取锁
t1获取到了锁
t2尝试获取锁
t1释放了锁
t2获取到了锁
t2释放了锁
</code></pre></div><h3 id="独占锁-写锁-共享锁-读锁-互斥锁"><a href="#独占锁-写锁-共享锁-读锁-互斥锁" class="header-anchor">#</a> 独占锁(写锁)/共享锁(读锁)/互斥锁</h3> <p>独占锁: 一个锁一次只能被一个线程持有</p> <p>共享锁: 该锁可以被多个线程持有</p> <p>读锁的共享锁可保证并发读是非常高效的, 读写,写读,写写的过程是互斥的</p> <p>如果一个线程有写共享资源, 就不应该有其他线程可以对该资源进行读或写</p> <p>读读能共存, 读写和写写不能共存</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">MyCache</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">ReentrantReadWriteLock</span> rwlock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rwlock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;正在写入:&quot;</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300l</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;写入完成:&quot;</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            rwlock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rwlock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;正在读取:&quot;</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300l</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Object</span> o <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;读取完成:&quot;</span> <span class="token operator">+</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            rwlock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MyCache</span> myCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> num <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                myCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> num <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                myCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>控制台输出<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">--</span><span class="token operator">-</span>如果不加锁的话<span class="token punctuation">,</span>从输出情况可知写的过程中会被其他加塞执行<span class="token operator">--</span><span class="token operator">-</span>
<span class="token operator">--</span><span class="token operator">-</span>加了读写锁之后<span class="token punctuation">,</span>当写入时<span class="token punctuation">,</span>没有其他读或者写操作进行<span class="token punctuation">,</span> 而读操作时可以多个读<span class="token punctuation">,</span>但是不能写<span class="token operator">--</span><span class="token operator">-</span>
<span class="token number">1</span>正在写入<span class="token operator">:</span><span class="token number">1</span>
<span class="token number">1</span>写入完成<span class="token operator">:</span><span class="token number">1</span>
<span class="token number">0</span>正在写入<span class="token operator">:</span><span class="token number">0</span>
<span class="token number">0</span>写入完成<span class="token operator">:</span><span class="token number">0</span>
<span class="token number">2</span>正在写入<span class="token operator">:</span><span class="token number">2</span>
<span class="token number">2</span>写入完成<span class="token operator">:</span><span class="token number">2</span>
<span class="token number">1</span>正在读取<span class="token operator">:</span><span class="token number">1</span>
<span class="token number">1</span>读取完成<span class="token operator">:</span><span class="token number">1</span>
<span class="token number">4</span>正在写入<span class="token operator">:</span><span class="token number">4</span>
<span class="token number">4</span>写入完成<span class="token operator">:</span><span class="token number">4</span>
<span class="token number">3</span>正在写入<span class="token operator">:</span><span class="token number">3</span>
<span class="token number">3</span>写入完成<span class="token operator">:</span><span class="token number">3</span>
<span class="token number">2</span>正在读取<span class="token operator">:</span><span class="token number">2</span>
<span class="token number">0</span>正在读取<span class="token operator">:</span><span class="token number">0</span>
<span class="token number">3</span>正在读取<span class="token operator">:</span><span class="token number">3</span>
<span class="token number">4</span>正在读取<span class="token operator">:</span><span class="token number">4</span>
<span class="token number">2</span>读取完成<span class="token operator">:</span><span class="token number">2</span>
<span class="token number">4</span>读取完成<span class="token operator">:</span><span class="token number">4</span>
<span class="token number">3</span>读取完成<span class="token operator">:</span><span class="token number">3</span>
<span class="token number">0</span>读取完成<span class="token operator">:</span><span class="token number">0</span>
</code></pre></div><h3 id="countdownlatch-cyclicbarrier-semaphore"><a href="#countdownlatch-cyclicbarrier-semaphore" class="header-anchor">#</a> CountDownLatch/CyclicBarrier/Semaphore</h3> <p>CountDownLatch  倒计时锁  减到零</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//倒计时锁 初始化5个</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> num <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;同学&quot;</span><span class="token operator">+</span>num<span class="token operator">+</span><span class="token string">&quot;走了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//每走一个计数减一</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//等待为0</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;班长锁门走人&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>CyclicBarrier   循环屏障    加到目标值   和CountDownLatch不同的是这些线程等待指定数量线程到达后再执行，CountDownLatch是一个或多个主线程等其他线程执行完之后执行</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BrokenBarrierException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">CyclicBarrier</span> cyclicBarrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;人到齐了,可以开饭了!!!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> num <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;同学&quot;</span><span class="token operator">+</span>num<span class="token operator">+</span><span class="token string">&quot;到了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    cyclicBarrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> <span class="token class-name">BrokenBarrierException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Semaphore  信号量</p> <p>相比较上面两个, 信号量是可以复用的</p> <p>主要用于两个目的: 一个用于多个共享资源的互斥使用, 另一个用于并发线程数的控制</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//五个车位</span>
        <span class="token class-name">Semaphore</span> semaphore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> num <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">//                if (semaphore.tryAcquire()) {   //尝试获取信号量,返回结果false或者true</span>
<span class="token comment">//                    System.out.println(&quot;用户&quot; + num + &quot;抢到车位了&quot;);</span>
<span class="token comment">//                }else {</span>
<span class="token comment">//                    System.out.println(&quot;用户&quot; + num + &quot;没抢到车位&quot;);</span>
<span class="token comment">//                }</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//获取信号量才能继续向下执行</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;用户&quot;</span> <span class="token operator">+</span> num <span class="token operator">+</span> <span class="token string">&quot;抢到车位了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000l</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;用户&quot;</span> <span class="token operator">+</span> num <span class="token operator">+</span> <span class="token string">&quot;离开车位&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment">//释放信号量</span>
                    semaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="阻塞队列"><a href="#阻塞队列" class="header-anchor">#</a> 阻塞队列</h3> <p>从空的阻塞队列中获取元素时会阻塞, 直到其他线程往空的队列中插入新的元素</p> <p>往满的阻塞队列中添加数据时会阻塞, 直到其他线程从队列中移除元素</p> <p><strong>种类分析</strong>:</p> <ol><li><strong>ArrayBlockingQueue</strong>: 由数组结构组成的有界阻塞队列</li> <li><strong>LinkedBlockingQueue</strong>: 由链表结构组成的有界(但大小默认值为Integer.MAX_VALUE)阻塞队列</li> <li>PriorityBlockingQueue: 支持优先级排序的无界阻塞队列</li> <li>DelayQueue: 使用优先级队列实现的延迟无界阻塞队列</li> <li><strong>SynchronousQueue</strong>: 不存储元素的阻塞队列, 也就是单个元素的队列</li> <li>LinkedTransferQueue: 由链表结构组成的无界阻塞队列</li> <li>LinkedBlockingDeque: 由链表结构组成的双向阻塞队列</li></ol> <p><strong>核心方法:</strong></p> <p><img src="/assets/img/3.71b0f558.png" alt=""></p> <h3 id="生产消费模式"><a href="#生产消费模式" class="header-anchor">#</a> 生产消费模式</h3> <p><strong>传统版</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">ShareDate</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//这个资源的锁</span>
    <span class="token keyword">private</span> <span class="token class-name">Condition</span> condition <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//锁实例条件</span>
    <span class="token comment">//num加一, 模拟生产</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//加锁</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//判断</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>num <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">//多线程的判断要用while</span>
                <span class="token comment">//不为0, 不能生产  等待</span>
                condition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//工作</span>
            num<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;::&quot;</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//工作结束,唤醒其余等待的线程</span>
            condition<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//num--,模拟消费动作</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//加锁</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//判断</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>num <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//等于0,   等待</span>
                condition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//工作</span>
            num<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;::&quot;</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//工作结束,唤醒其余等待的线程</span>
            condition<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ShareDate</span> shareDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShareDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//五个线程生产</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
                shareDate<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;生产者&quot;</span><span class="token operator">+</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//五个线程消费</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
                shareDate<span class="token punctuation">.</span><span class="token function">decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;消费者&quot;</span><span class="token operator">+</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>控制台输出<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
生产者<span class="token number">2</span><span class="token operator">::</span><span class="token number">1</span>
消费者<span class="token number">1</span><span class="token operator">::</span><span class="token number">0</span>
生产者<span class="token number">3</span><span class="token operator">::</span><span class="token number">1</span>
消费者<span class="token number">2</span><span class="token operator">::</span><span class="token number">0</span>
生产者<span class="token number">0</span><span class="token operator">::</span><span class="token number">1</span>
消费者<span class="token number">0</span><span class="token operator">::</span><span class="token number">0</span>
生产者<span class="token number">1</span><span class="token operator">::</span><span class="token number">1</span>
消费者<span class="token number">4</span><span class="token operator">::</span><span class="token number">0</span>
生产者<span class="token number">4</span><span class="token operator">::</span><span class="token number">1</span>
消费者<span class="token number">3</span><span class="token operator">::</span><span class="token number">0</span>
</code></pre></div><p><strong>通过阻塞队列版本</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">ShareDate</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token comment">//默认开启生产+消费</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> atomicInteger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> blockingQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ShareDate</span><span class="token punctuation">(</span><span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> blockingQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>blockingQueue <span class="token operator">=</span> blockingQueue<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">prod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> retValue<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            data <span class="token operator">=</span> atomicInteger<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
            retValue <span class="token operator">=</span> blockingQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">2l</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;插入队列结果:&quot;</span> <span class="token operator">+</span> retValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;生产停止!!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> blockingQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token number">2l</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;长时间没有消费成功, 停工!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;消费队列成功:&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ShareDate</span> shareDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShareDate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                shareDate<span class="token punctuation">.</span><span class="token function">prod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;生产者&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                shareDate<span class="token punctuation">.</span><span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;消费者&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        shareDate<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;停工!!!!!!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="synchronized和lock有什么区别"><a href="#synchronized和lock有什么区别" class="header-anchor">#</a> synchronized和lock有什么区别</h3> <ol><li><strong>原始构成:</strong> <ol><li>synchronized是关键字, jvm层面</li> <li>lock是具体类, 是api层面的</li></ol></li> <li><strong>使用方法</strong> <ol><li>synchronized不需要手动释放锁, 代码块内执行完系统自动释放</li> <li>lock需要手动lock和unlock进行加锁解锁</li></ol></li> <li><strong>等待是否可中断</strong> <ol><li>synchronized不能中断, 除非抛出异常或者正常运行完成</li> <li>lock可以中断, 1.设置超时 tryLock   2.lockInterruptibly()放代码块中, 调用interrupt()可中断</li></ol></li> <li><strong>加锁是否公平</strong> <ol><li>synchronized默认非公平锁</li> <li>reentrantLock默认非公平, 可以通过构造方法传入true便是公平锁</li></ol></li> <li><strong>锁绑定多个条件Condition</strong> <ol><li>synchronized没有</li> <li>reentrantLock用来实现分组唤醒需要唤醒的线程们, 可以精确唤醒, 而不是想synchronized要么随机唤醒要么全部唤醒</li></ol></li></ol> <h3 id="reentrantlock怎么精确唤醒线程-比如a→b→c依次唤醒线程"><a href="#reentrantlock怎么精确唤醒线程-比如a→b→c依次唤醒线程" class="header-anchor">#</a> ReentrantLock怎么精确唤醒线程,比如A→B→C依次唤醒线程</h3> <p>使用多个锁条件, 线程A等待c1   线程B等待c2   线程C等待c3   唤醒那个条件的线程便能控制下一步走向</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Condition</span> c1 <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">Condition</span> c2 <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">Condition</span> c3 <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//锁实例条件</span>
</code></pre></div><h3 id="locksupport"><a href="#locksupport" class="header-anchor">#</a> LockSupport</h3> <ol><li><p>是什么?</p> <p>JUC下的一个lock是包下一个类</p> <p>LockSupport是用来创建锁和其他同步类的基本线程阻塞原语</p> <p>LockSupport是一个线程阻塞工具类, 所有的方法都是静态方法, 可以让线程在任何位置阻塞, 阻塞之后也有对应的唤醒方法. 归根结底, LockSupport调用的Unsafe中的native代码</p> <p>LockSupport中的park() 和 unpark() 的作用分别是阻塞线程和接触阻塞线程  不用在锁块内</p> <p>LockSupport和每个使用它的线程都有一个许可permit关联, permit相当于1, 0 的开关, 默认是0</p> <p>调用依次unpark就加1变成1</p> <p>调用park会消费permit, 也就是1变成0, 同事park立即返回</p> <p>如果再次调用park会变成阻塞(因为permit为0了, 需要等permit变成1), 这是调用unpark会把permit置为1</p> <p>每个线程都有一个相关的permit, permit最多只有一个, 重复调用unpark也不会积累凭<strong>证</strong></p> <p><strong>线程阻塞需要消耗凭证, 凭证最多只有一个</strong></p> <p>调用park时, 如果有凭证,直接消耗凭证然后正常退出; 如果没有凭证,则阻塞等待凭证可用</p> <p>调用unpark则相反, 会增加一个凭证, 但最多一个, 累加无效</p></li> <li><p>使用</p> <ol><li><p>park()/park(Object blocker)</p> <p>阻塞当前线程/阻塞传入的具体线程</p></li> <li><p>unpack(Thread thread)</p> <p>唤醒处于阻塞状态的指定线程,  先执行unpark()会使后行的park()失效</p></li></ol></li></ol> <h3 id="三种让线程等待的方法"><a href="#三种让线程等待的方法" class="header-anchor">#</a> 三种让线程等待的方法</h3> <ol><li><p>使用object中的wait()方法让线程等待, 使用Object中的notify()方法唤醒线程
wait和notify方法必须在同步块或者方法里面
先wait在notify才可以</p></li> <li><p>使用JUC包中Condition的await()方法让线程等待, 使用signal()方法唤醒线程
await和signal也必须同步块中
有先后顺序, 先await在notify</p></li> <li><p>LockSupport类可以阻塞当前线程以及唤醒等待指定被阻塞的线程</p> <p>不用在锁块内</p> <p>而且错误的先唤醒在等待也可以支持</p></li></ol> <h2 id="aqs"><a href="#aqs" class="header-anchor">#</a> AQS</h2> <p>AbstractQueuedSynchronizer   抽象的队列同步器, 这个类在<code>java.util.concurrent.locks</code>包下面。</p> <p>reentrantLock的实现原理就是AQS</p> <ol><li><p>技术解释</p> <p>是用来构建锁或者其他同步器组件的重量级基础框架及整个JUC体系的基石, 通过内置的FIFO队列来完成资源获取线程的排队工作, 并通过一个int类型变量表示持有锁的状态</p> <p>如果共享资源被占用, 就需要一定的阻塞等待唤醒机制来保证锁分配, 这个机制主要用的是CLH队列的变体实现的, 将暂时获取不到锁的线程加入到队列中, 这个队列就是AQS的抽象表现, 他将请求共享资源的线程封装成队列的节点(Node), 通过CAS、自旋以及LockSupport.park()的方式, 维护state变量的状态, 使并发达到同步的控制效果.</p> <p>AQS使用一个volatile的int类型的成员变量来表示同步状态, 通过内置的FIFO队列来完成资源获取的排队工作将每条要去抢占资源的线程封装成一个Node节点来实现锁的分配, 通过CAS完成堆State值得修改</p> <p><img src="/assets/img/4.935af692.png" alt=""></p></li></ol> <p><img src="/assets/img/5.ace2a4b3.png" alt=""></p> <p><img src="/assets/img/6.c4a9b08c.png" alt=""></p> <h3 id="aqs源码"><a href="#aqs源码" class="header-anchor">#</a> AQS源码</h3> <ol><li><p>以reentrantLock.lock()方法为例, 运用了AQS+CAS+自旋    jdk11的源码</p> <ol><li><p>调用lock()方法后, 实际调用的<code>AbstractQueuedSynchronizer</code>的<code>acquire</code>方法
这里又分了三步</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">EXCLUSIVE</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>tryAcquire(arg)</code>这里调用的是<code>AbstractQueuedSynchronizer</code>的实现类重写的方法, 以不公平锁为例
这是最后执行的代码</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//拿到当前线程</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//拿到当前资源的状态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">//判断是否资源被占用</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//如果没有占用,通过CAS尝试占用</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//占用成功后,将占用线程存为自己</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>   <span class="token comment">//返回true, 前面代码取反后,便不走其他两个方法</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//如果资源被占用了,判断是不是自己,这一步就是可重入锁的关键</span>
        <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// overflow</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Maximum lock count exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token comment">//返回后被取反,执行后一个方法</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>addWaiter(Node.*EXCLUSIVE*)</code>添加等待,传入的其实是个null,</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Node</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//新建node节点,构造函数里面获取当前线程</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">//自旋</span>
        <span class="token class-name">Node</span> oldTail <span class="token operator">=</span> tail<span class="token punctuation">;</span>   <span class="token comment">//获取尾结点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldTail <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//如果有</span>
            node<span class="token punctuation">.</span><span class="token function">setPrevRelaxed</span><span class="token punctuation">(</span>oldTail<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//将尾结点设置为当前节点的前一位</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>oldTail<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//CAS尝试将尾结点替换为当前节点</span>
                oldTail<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>   <span class="token comment">//替换成功后将老的尾结点的下一位设置为当前节点</span>
                <span class="token keyword">return</span> node<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">initializeSyncQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//如果尾结点为null,表示没人等待,初始化一个队列, new了一个空的傀儡节点,再循环尝试将自己挂上去</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>acquireQueued</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">//自旋</span>
            <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//当前节点的前一位</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//如果头结点是前一位, 则尝试获取</span>
                <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//获取成功后, 设置当前为头结点</span>
                p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC  </span>
                <span class="token keyword">return</span> interrupted<span class="token punctuation">;</span> 
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span>
                interrupted <span class="token operator">|=</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//通过LockSupport.park挂起当前节点</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>interrupted<span class="token punctuation">)</span>
						<span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol></li> <li><p><code>unlock()</code>方法,</p> <ol><li><p>实际调用的<code>AbstractQueuedSynchronizer</code>的<code>release</code>方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryRelease</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">//尝试解锁</span>
        <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>  <span class="token comment">//获取头结点,如果unlock这个锁当时没进队列,那么这就是获取的傀儡节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//头结点不为null, 等待状态也不为0</span>
            <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//唤醒</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>tryRelease(arg)</code> 方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> releases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> releases<span class="token punctuation">;</span>   
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> free <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//如果资源状态==0了,释放成功</span>
        free <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//正在执行线程置为null</span>
    <span class="token punctuation">}</span>
    <span class="token function">setState</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//更新资源状态</span>
    <span class="token keyword">return</span> free<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>unparkSuccessor(h)</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> ws <span class="token operator">=</span> node<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>  <span class="token comment">//当前节点的等待状态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        node<span class="token punctuation">.</span><span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Node</span> s <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>   <span class="token comment">//获取下一位节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> s<span class="token punctuation">.</span>waitStatus <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//如果没有下一位,或者下一位等待状态大于0  </span>
        s <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span> p <span class="token operator">=</span> tail<span class="token punctuation">;</span> p <span class="token operator">!=</span> node <span class="token operator">&amp;&amp;</span> p <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token punctuation">.</span>prev<span class="token punctuation">)</span>   <span class="token comment">//从尾结点往前推找可执行的</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                s <span class="token operator">=</span> p<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>   <span class="token comment">//如果下一位存在,唤醒其线程</span>
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol></li></ol></div></div> <!----> <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/bf25fe/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Gateway网关</div></a> <a href="/pages/fd10b9/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">分布式事务</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/bf25fe/" class="prev">Gateway网关</a></span> <span class="next"><a href="/pages/fd10b9/">分布式事务</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2023
    <span>张大喵</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5f14dbf8.js" defer></script><script src="/assets/js/2.067d241c.js" defer></script><script src="/assets/js/4.ba4eeead.js" defer></script>
  </body>
</html>
